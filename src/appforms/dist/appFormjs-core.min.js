if("undefined"==typeof window)var window={};!function(){function a(a){function b(){return e}var c={},d={exports:{}};!function(){function a(a){var c=!1;return function(){if(c)throw new Error("Callback was already called.");c=!0,a.apply(b,arguments)}}var b,e,f={};b=this,null!=b&&(e=b.async),f.noConflict=function(){return b.async=e,f};var g=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},h=function(a,b){if(a.map)return a.map(b);var c=[];return g(a,function(a,d,e){c.push(b(a,d,e))}),c},i=function(a,b,c){return a.reduce?a.reduce(b,c):(g(a,function(a,d,e){c=b(c,a,d,e)}),c)},j=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};"undefined"!=typeof process&&process.nextTick?(f.nextTick=process.nextTick,f.setImmediate="undefined"!=typeof setImmediate?setImmediate:f.nextTick):"function"==typeof setImmediate?(f.nextTick=function(a){setImmediate(a)},f.setImmediate=f.nextTick):(f.nextTick=function(a){setTimeout(a,0)},f.setImmediate=f.nextTick),f.each=function(b,c,d){if(d=d||function(){},!b.length)return d();var e=0;g(b,function(f){c(f,a(function(a){a?(d(a),d=function(){}):(e+=1,e>=b.length&&d(null))}))})},f.forEach=f.each,f.eachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c(null):e())})};e()},f.forEachSeries=f.eachSeries,f.eachLimit=function(a,b,c,d){var e=k(b);e.apply(null,[a,c,d])},f.forEachLimit=f.eachLimit;var k=function(a){return function(b,c,d){if(d=d||function(){},!b.length||0>=a)return d();var e=0,f=0,g=0;!function h(){if(e>=b.length)return d();for(;a>g&&f<b.length;)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})}()}},l=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[f.each].concat(b))}},m=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[k(a)].concat(c))}},n=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[f.eachSeries].concat(b))}},o=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})};f.map=l(o),f.mapSeries=n(o),f.mapLimit=function(a,b,c,d){return p(b)(a,c,d)};var p=function(a){return m(a,o)};f.reduce=function(a,b,c,d){f.eachSeries(a,function(a,d){c(b,a,function(a,c){b=c,d(a)})},function(a){d(a,b)})},f.inject=f.reduce,f.foldl=f.reduce,f.reduceRight=function(a,b,c,d){var e=h(a,function(a){return a}).reverse();f.reduce(e,b,c,d)},f.foldr=f.reduceRight;var q=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};f.filter=l(q),f.filterSeries=n(q),f.select=f.filter,f.selectSeries=f.filterSeries;var r=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};f.reject=l(r),f.rejectSeries=n(r);var s=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(){d()})};f.detect=l(s),f.detectSeries=n(s),f.some=function(a,b,c){f.each(a,function(a,d){b(a,function(a){a&&(c(!0),c=function(){}),d()})},function(){c(!1)})},f.any=f.some,f.every=function(a,b,c){f.each(a,function(a,d){b(a,function(a){a||(c(!1),c=function(){}),d()})},function(){c(!0)})},f.all=f.every,f.sortBy=function(a,b,c){f.map(a,function(a,c){b(a,function(b,d){b?c(b):c(null,{value:a,criteria:d})})},function(a,b){if(a)return c(a);var d=function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0};c(null,h(b.sort(d),function(a){return a.value}))})},f.auto=function(a,b){b=b||function(){};var c=j(a);if(!c.length)return b(null);var d={},e=[],h=function(a){e.unshift(a)},k=function(a){for(var b=0;b<e.length;b+=1)if(e[b]===a)return e.splice(b,1),void 0},l=function(){g(e.slice(0),function(a){a()})};h(function(){j(d).length===c.length&&(b(null,d),b=function(){})}),g(c,function(c){var e=a[c]instanceof Function?[a[c]]:a[c],m=function(a){var e=Array.prototype.slice.call(arguments,1);if(e.length<=1&&(e=e[0]),a){var h={};g(j(d),function(a){h[a]=d[a]}),h[c]=e,b(a,h),b=function(){}}else d[c]=e,f.setImmediate(l)},n=e.slice(0,Math.abs(e.length-1))||[],o=function(){return i(n,function(a,b){return a&&d.hasOwnProperty(b)},!0)&&!d.hasOwnProperty(c)};if(o())e[e.length-1](m,d);else{var p=function(){o()&&(k(p),e[e.length-1](m,d))};h(p)}})},f.waterfall=function(a,b){if(b=b||function(){},a.constructor!==Array){var c=new Error("First argument to waterfall must be an array of functions");return b(c)}if(!a.length)return b();var d=function(a){return function(c){if(c)b.apply(null,arguments),b=function(){};else{var e=Array.prototype.slice.call(arguments,1),g=a.next();g?e.push(d(g)):e.push(b),f.setImmediate(function(){a.apply(null,e)})}}};d(f.iterator(a))()};var t=function(a,b,c){if(c=c||function(){},b.constructor===Array)a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(j(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};f.parallel=function(a,b){t({map:f.map,each:f.each},a,b)},f.parallelLimit=function(a,b,c){t({map:p(b),each:k(b)},a,c)},f.series=function(a,b){if(b=b||function(){},a.constructor===Array)f.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};f.eachSeries(j(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}},f.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},f.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var u=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};f.concat=l(u),f.concatSeries=n(u),f.whilst=function(a,b,c){a()?b(function(d){return d?c(d):(f.whilst(a,b,c),void 0)}):c()},f.doWhilst=function(a,b,c){a(function(d){return d?c(d):(b()?f.doWhilst(a,b,c):c(),void 0)})},f.until=function(a,b,c){a()?c():b(function(d){return d?c(d):(f.until(a,b,c),void 0)})},f.doUntil=function(a,b,c){a(function(d){return d?c(d):(b()?c():f.doUntil(a,b,c),void 0)})},f.queue=function(b,c){function d(a,b,d,e){b.constructor!==Array&&(b=[b]),g(b,function(b){var g={data:b,callback:"function"==typeof e?e:null};d?a.tasks.unshift(g):a.tasks.push(g),a.saturated&&a.tasks.length===c&&a.saturated(),f.setImmediate(a.process)})}void 0===c&&(c=1);var e=0,h={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,push:function(a,b){d(h,a,!1,b)},unshift:function(a,b){d(h,a,!0,b)},process:function(){if(e<h.concurrency&&h.tasks.length){var c=h.tasks.shift();h.empty&&0===h.tasks.length&&h.empty(),e+=1;var d=function(){e-=1,c.callback&&c.callback.apply(c,arguments),h.drain&&h.tasks.length+e===0&&h.drain(),h.process()},f=a(d);b(c.data,f)}},length:function(){return h.tasks.length},running:function(){return e}};return h},f.cargo=function(a,b){var c=!1,d=[],e={tasks:d,payload:b,saturated:null,empty:null,drain:null,push:function(a,c){a.constructor!==Array&&(a=[a]),g(a,function(a){d.push({data:a,callback:"function"==typeof c?c:null}),e.saturated&&d.length===b&&e.saturated()}),f.setImmediate(e.process)},process:function i(){if(!c){if(0===d.length)return e.drain&&e.drain(),void 0;var f="number"==typeof b?d.splice(0,b):d.splice(0),j=h(f,function(a){return a.data});e.empty&&e.empty(),c=!0,a(j,function(){c=!1;var a=arguments;g(f,function(b){b.callback&&b.callback.apply(null,a)}),i()})}},length:function(){return d.length},running:function(){return c}};return e};var v=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&g(c,function(b){console[a](b)}))}]))}};f.log=v("log"),f.dir=v("dir"),f.memoize=function(a,b){var c={},d={};b=b||function(a){return a};var e=function(){var e=Array.prototype.slice.call(arguments),f=e.pop(),g=b.apply(null,e);g in c?f.apply(null,c[g]):g in d?d[g].push(f):(d[g]=[f],a.apply(null,e.concat([function(){c[g]=arguments;var a=d[g];delete d[g];for(var b=0,e=a.length;e>b;b++)a[b].apply(null,arguments)}])))};return e.memo=c,e.unmemoized=a,e},f.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},f.times=function(a,b,c){for(var d=[],e=0;a>e;e++)d.push(e);return f.map(d,b,c)},f.timesSeries=function(a,b,c){for(var d=[],e=0;a>e;e++)d.push(e);return f.mapSeries(d,b,c)},f.compose=function(){var a=Array.prototype.reverse.call(arguments);return function(){var b=this,c=Array.prototype.slice.call(arguments),d=c.pop();f.reduce(a,c,function(a,c,d){c.apply(b,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,c){d.apply(b,[a].concat(c))})}};var w=function(a,b){var c=function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();return a(b,function(a,b){a.apply(c,d.concat([b]))},e)};if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return c.apply(this,d)}return c};f.applyEach=l(w),f.applyEachSeries=n(w),f.forever=function(a,b){function c(d){if(d){if(b)return b(d);throw d}a(c)}c()},"undefined"!=typeof c&&c.amd?c([],function(){return f}):"undefined"!=typeof d&&d.exports?d.exports=f:b.async=f}();var e=d.exports;return function(){function a(a,b,c){var d=parseInt(a,10);return!isNaN(d)&&d>=b&&c>=d}function c(b){var c=0;if("string"==typeof b){var d=b.split(":");valid=2===d.length||3===d.length,valid&&(valid=a(d[0],0,23),c+=60*parseInt(d[0],10)*60),valid&&(valid=a(d[1],0,59),c+=60*parseInt(d[1],10)),valid&&3===d.length&&(valid=a(d[2],0,59),c+=parseInt(d[2],10))}return c}function e(a,b,d,e){var f=a.type,l=a.fieldOptions,m=!0;if("is equal to"===e)m=b===d;else if("is greater than"===e)m=b>d;else if("is less than"===e)m=d>b;else if("is at"===e){if(m=!1,f===h)switch(l.definition.dateTimeUnit){case i:try{m=new Date(new Date(b).toDateString()).getTime()==new Date(new Date(d).toDateString()).getTime()}catch(n){m=!1}break;case j:m=c(b)===c(d);break;case k:try{m=new Date(b).getTime()==new Date(d).getTime()}catch(n){m=!1}break;default:m=!1}}else if("is before"===e){if(m=!1,f===h)switch(l.definition.dateTimeUnit){case i:try{m=new Date(new Date(b).toDateString()).getTime()<new Date(new Date(d).toDateString()).getTime()}catch(n){m=!1}break;case j:m=c(b)<c(d);break;case k:try{m=new Date(b).getTime()<new Date(d).getTime()}catch(n){m=!1}break;default:m=!1}}else if("is after"===e){if(m=!1,f===h)switch(l.definition.dateTimeUnit){case i:try{m=new Date(new Date(b).toDateString()).getTime()>new Date(new Date(d).toDateString()).getTime()}catch(n){m=!1}break;case j:m=c(b)>c(d);break;case k:try{m=new Date(b).getTime()>new Date(d).getTime()}catch(n){m=!1}break;default:m=!1}}else m="is"===e?f===g?b&&b.selections&&-1!==b.selections.indexOf(d):b===d:"is not"===e?f===g?b&&b.selections&&-1===b.selections.indexOf(d):b!==d:"contains"===e?-1!==b.indexOf(d):"does not contain"===e?-1===b.indexOf(d):"begins with"===e?b.substring(0,d.length)===d:"ends with"===e?b.substring(Math.max(0,b.length-d.length),b.length)===d:!1;return m}var f=b("async"),g="checkboxes",h="dateTime",i="date",j="time",k="dateTime",l=function(b){function c(a){f.each(T.pages,function(a,b){f.each(a.fields,function(b,c){return b.pageId=a._id,U[b._id]=b,b.required&&(V[b._id]={field:b,submitted:!1,validated:!1}),c()},function(){return b()})},a)}function d(a){f.each(T.fieldRules,function(a,b){f.each(a.ruleConditionalStatements,function(b,c){var d=b.sourceField;return X[d]=X[d]||[],X[d].push(a),c()},function(){return Y[a.targetField]=Y[a.targetField]||[],Y[a.targetField].push(a),b()})},a)}function g(a){f.each(T.pageRules,function(a,b){a._id;f.each(a.ruleConditionalStatements,function(b,c){var d=b.sourceField;return Z[d]=Z[d]||[],Z[d].push(a),c()},function(){return $[a.targetPage]=$[a.targetPage]||[],$[a.targetPage].push(a),b()})},a)}function h(a){W=JSON.parse(JSON.stringify(V)),_={},f.each(S.formFields,function(a,b){return a.fieldId?(_[a.fieldId]=a,b()):b(new Error("No fieldId in this submission entry: "+util.inspect(a)))},a)}function l(a){return R?a():(f.parallel([c,d,g],function(b){return b?a(b):(R=!0,a())}),void 0)}function m(a,b){l(function(c){return c?b(c):(S=a,h(b),void 0)})}function n(a,b,c){return b&&b.formFields?(f.filter(b.formFields,function(b,c){return c(b.fieldId.toString()==a.fieldId.toString())},function(a){var b=null;return a&&a[0]&&a[0].fieldValues&&(b=a[0].fieldValues),c(void 0,b)}),void 0):c()}function o(a,b,c){"function"==typeof b&&(c=b,b=null),l(function(d){return d?c(d):(m(a,function(a){return a?c(a):(f.waterfall([function(a){return a(void 0,{validation:{valid:!0}})},function(a,c){p(a,b,c)},q],function(a,b){return a?c(a):c(void 0,b)}),void 0)}),void 0)})}function p(a,b,c){f.each(S.formFields,function(c,d){var e=c.fieldId,f=U[e];n(c,b,function(b,g){return b?d(b):(u(c,f,g,function(b,c){return b?d(b):(c.valid||(a.validation.valid=!1,a.validation[e]=c),d())}),void 0)})},function(b){return b?c(b):c(void 0,a)})}function q(a,b){f.each(Object.keys(W),function(b,c){var d={};return W[b].submitted?c():(P(b,!0,function(e,f){return e?c(e):(f&&(d.fieldId=b,d.valid=!1,d.fieldErrorMessage=["Required Field Not Submitted"],a.validation[b]=d,a.validation.valid=!1),c())}),void 0)},function(c){return c?b(c):b(void 0,a)})}function r(a,b,c){l(function(d){return d?c(d):(m(b,function(b){if(b)return c(b);var d=_[a],e=U[a];u(d,e,null,function(b,d){if(b)return c(b);var e={validation:{}};return e.validation[a]=d,c(void 0,e)})}),void 0)})}function s(a,b,c,d){function e(b,c){var d={errorMessages:[]};return b&&d.errorMessages.push(b),t(a,d,function(b,d){if(b)return c(b);var e={validation:{}};return e.validation[a]=d,c(void 0,e)})}"function"==typeof c&&(d=c,c=0),l(function(f){if(f)return d(f);var g=U[a],h=!1;return h=g.repeating&&g.fieldOptions&&g.fieldOptions.definition&&g.fieldOptions.definition.minRepeat?c<g.fieldOptions.definition.minRepeat:g.required,!h||"undefined"!=typeof b&&null!==b?h||"undefined"!=typeof b&&null!==b?(x(g.type,function(a,c){return a?d(a):(c(b,g,void 0,function(a){var b;a&&(b=a.message?a.message:"Unknown error message"),e(b,d)}),void 0)}),void 0):e(void 0,d):e("No value specified for required input",d)})}function t(a,b,c){var d={};d.fieldId=a,d.errorMessages=b.errorMessages||[],d.fieldErrorMessage=b.fieldErrorMessage||[],f.some(d.errorMessages,function(a,b){return b(null!==a)},function(a){return d.valid=!a&&d.fieldErrorMessage.length<1,c(void 0,d)})}function u(a,b,c,d){y(a,b,c,function(b,c){return b?d(b):(t(a.fieldId,c,d),void 0)})}function v(a,b,c){var d=b[a];return d?c(void 0,d):c(new Error("Invalid Field Type "+a))}function w(a,b){return v(a,ab,b)}function x(a,b){return v(a,bb,b)}function y(a,b,c,d){function e(a,b,c){var d=a&&a.fieldValues&&a.fieldValues.length>0;return d?c(void 0,null):c(void 0,"No value submitted for field "+b.name)}function g(a,b){var c=0;if(a&&a.fieldValues&&a.fieldValues.length>0)for(var d=0;d<a.fieldValues.length;d+=1)a.fieldValues[d]&&(c+=1);return b(void 0,c)}function h(a,b,c){if(b.repeating&&b.fieldOptions.definition){if(b.fieldOptions.definition.minRepeat&&a<b.fieldOptions.definition.minRepeat)return c(void 0,"Expected min of "+b.fieldOptions.definition.minRepeat+" values for field "+b.name+" but got "+a);if(b.fieldOptions.definition.maxRepeat&&a>b.fieldOptions.definition.maxRepeat)return c(void 0,"Expected max of "+b.fieldOptions.definition.maxRepeat+" values for field "+b.name+" but got "+a)}else if(a>1)return c(void 0,"Should not have multiple values for non-repeating field");return c(void 0,null)}function i(a,b,c,d){w(b.type,function(e,g){f.map(a.fieldValues,function(a,d){return"undefined"==typeof a||null===a?d(void 0,null):(g(a,b,c,function(a){var c;return c=a?a.message||"Error during validation of field":null,W[b._id]&&(W[b._id].submitted=!0),d(void 0,c)}),void 0)},function(a,b){return a?d(a):d(void 0,b)})})}"function"==typeof c&&(d=c,c=null),g(a,function(g,j){return g?d(g):(f.series({valuesSubmitted:f.apply(e,a,b),repeats:f.apply(h,j,b),values:f.apply(i,a,b,c)},function(a,b){if(a)return d(a);var c=[];return b.valuesSubmitted&&c.push(b.valuesSubmitted),b.repeats&&c.push(b.repeats),d(void 0,{fieldErrorMessage:c,errorMessages:b.values})}),void 0)})}function z(a,b,c,d){return"string"!=typeof a?d(new Error("Expected string but got "+typeof a)):b.fieldOptions&&b.fieldOptions.validation&&b.fieldOptions.validation.min&&a.length<b.fieldOptions.validation.min?d(new Error("Expected minimum string length of "+b.fieldOptions.validation.min+" but submission is "+a.length+". Submitted val: "+a)):b.fieldOptions&&b.fieldOptions.validation&&b.fieldOptions.validation.max&&a.length>b.fieldOptions.validation.max?d(new Error("Expected maximum string length of "+b.fieldOptions.validation.max+" but submission is "+a.length+". Submitted val: "+a)):d()}function A(a,b,c,d){return"number"!=typeof a?d(new Error("Expected number but got "+typeof a)):b.fieldOptions&&b.fieldOptions.validation&&b.fieldOptions.validation.min&&a<b.fieldOptions.validation.min?d(new Error("Expected minimum Number "+b.fieldOptions.validation.min+" but submission is "+a+". Submitted number: "+a)):b.fieldOptions.validation.max&&a>b.fieldOptions.validation.max?d(new Error("Expected maximum Number "+b.fieldOptions.validation.max+" but submission is "+a+". Submitted number: "+a)):d()}function B(a,b,c,d){return"string"!=typeof a?d(new Error("Expected string but got "+typeof a)):null===a.match(/[-0-9a-zA-Z.+_]+@[-0-9a-zA-Z.+_]+\.[a-zA-Z]{2,4}/g)?d(new Error("Invalid email address format: "+a)):d()}function C(a,b,c,d){if("string"!=typeof a)return d(new Error("Expected dropdown submission to be string but got "+typeof a));if(!b.fieldOptions.definition.options)return d(new Error("No dropdown options exist for field "+b.name));var e=b.fieldOptions.definition.options.filter(function(b){return b.label===a});return 1!==e.length?d(new Error("Invalid number of dropdown options found: "+e.length)):d()}function D(a,b,c,d){if("string"!=typeof a)return d(new Error("Expected radio submission to be string but got "+typeof a));if(!b.fieldOptions.definition.options)return d(new Error("No radio options exist for field "+b.name));var e=b.fieldOptions.definition.options.filter(function(b){return b.label===a});return 1!==e.length?d(new Error("Invalid number of radio options found: "+e.length)):d()}function E(a,b,c,d){var e;b&&b.fieldOptions&&b.fieldOptions.validation&&(e=b.fieldOptions.validation.min);var g;if(b&&b.fieldOptions&&b.fieldOptions.validation&&(g=b.fieldOptions.validation.max),e&&(null===a.selections||void 0===a.selections||a.selections.length<e)){var h;return a.selections&&(h=a.selections.length),d(new Error("Expected a minimum number of selections "+e+" but got "+h))}if(g&&a.selections&&a.selections.length>g)return d(new Error("Expected a maximum number of selections "+g+" but got "+a.selections.length));var i=[];f.eachSeries(b.fieldOptions.definition.options,function(a,b){for(var c in a)i.push(c);return b()},function(){f.eachSeries(a.selections,function(a,b){return"string"!=typeof a?b(new Error("Expected checkbox submission to be string but got "+typeof a)):-1===i.indexOf(a)?b(new Error("Checkbox Option "+a+" does not exist in the field.")):b()},d)})}function F(a,b,c,d){return a.lat&&a.long?isNaN(parseFloat(a.lat))||isNaN(parseFloat(a.lat))?d(new Error("Invalid latitude and longitude values")):d():d(new Error("Invalid object for locationMap submission"))}function G(a,b,c,d){function e(a,b){return"string"!=typeof a.zone||3!==a.zone.length?b(new Error("Invalid zone definition for northings and eastings location. "+a.zone)):"string"!=typeof a.eastings||6!==a.eastings.length?b(new Error("Invalid eastings definition for northings and eastings location. "+a.eastings)):"string"!=typeof a.northings||7!==a.northings.length?b(new Error("Invalid northings definition for northings and eastings location. "+a.northings)):b()}return"latLong"===b.fieldOptions.definition.locationUnit?a.lat&&a.long?isNaN(parseFloat(a.lat))||isNaN(parseFloat(a.lat))?d(new Error("Invalid latitude and longitude values")):d():d(new Error("Invalid object for latitude longitude submission")):a.zone&&a.eastings&&a.northings?e(a,d):d(new Error("Invalid object for northings easting submission. Zone, Eastings and Northings elemets are required"))}function H(a,b,c,d){K(a,b,c,function(e){return e?(I(a,b,c,function(e){return e?(J(a,b,c,function(a){return a?d(a):d()}),void 0):d()}),void 0):d()})}function I(a,b,c,d){if("object"!=typeof a)return d(new Error("Expected object but got "+typeof a));var e=[{keyName:"fileName",valueType:"string"},{keyName:"fileSize",valueType:"number"},{keyName:"fileType",valueType:"string"},{keyName:"fileUpdateTime",valueType:"number"},{keyName:"hashName",valueType:"string"}];f.each(e,function(b,c){var d=typeof a[b.keyName];return d!==b.valueType?c(new Error("Expected "+b.valueType+" but got "+d)):"fileName"===b.keyName&&a[b.keyName].length<=0?c(new Error("Expected value for "+b.keyName)):c()},function(b){return b?d(b):a.hashName.indexOf("filePlaceHolder")>-1?d():c&&c.hashName&&c.hashName.indexOf(a.hashName)>-1?d():d(new Error("Invalid file placeholder text"+a.hashName))})}function J(a,b,c,d){if("function"!=typeof File||!(a instanceof File))return d(new Error("Expected File object but got "+typeof a));var e=[{keyName:"name",valueType:"string"},{keyName:"size",valueType:"number"}];f.each(e,function(b,c){var d=typeof a[b.keyName];return d!==b.valueType?c(new Error("Expected "+b.valueType+" but got "+d)):"string"===d&&a[b.keyName].length<=0?c(new Error("Expected value for "+b.keyName)):"number"===d&&a[b.keyName]<=0?c(new Error("Expected > 0 value for "+b.keyName)):c()},function(a){return a?d(a):d()})}function K(a,b,c,d){return"string"!=typeof a?d(new Error("Expected base64 string but got "+typeof a)):a.length<=0?d(new Error("Expected base64 string but was empty")):d()}function L(b,c,d,e){var f;if("string"!=typeof b)return e(new Error("Expected string but got "+typeof b));switch(c.fieldOptions.definition.dateTimeUnit){case i:try{f=new Date(b),valid="Invalid Date"!==f.toString()}catch(g){valid=!1}return valid?e():e(new Error("Invalid date value "+b));case j:var h=b.split(":");return valid=2===h.length||3===h.length,valid&&(valid=a(h[0],0,23)),valid&&(valid=a(h[1],0,59)),valid&&3===h.length&&(valid=a(h[2],0,59)),valid?e():e(new Error("Invalid date value "+b));case k:try{return f=new Date(b),"Invalid Date"===f.toString()?e(new Error("Invalid dateTime string "+b)):e()}catch(g){return e(new Error("Invalid dateTime string "+b))}break;default:return e(new Error("Invalid dateTime fieldtype "+fieldOptions.definition.dateTimeUnit))}}function M(a,b,c,d){return d(new Error("Should not submit section field: "+b.name))}function N(a,b){var c=!0;f.each(a,function(a,b){var d=[],g=[];f.each(a.ruleConditionalStatements,function(a,b){var c=U[a.sourceField],f=!1,h=[];if(_[a.sourceField]&&_[a.sourceField].fieldValues){h=_[a.sourceField].fieldValues;var i=a.restriction,j=a.sourceValue;f=e(c,h[0],j,i)}return d.push({field:c,submissionValues:h,condition:i,testValue:j,passed:f}),f&&g.push(c),b()},function(e){function f(a,b,c){return"and"===a&&b.length==c.length||"or"===a&&b.length>0}return e&&b(e),c=f(a.ruleConditionalOperator,g,d)?"show"===a.type:"show"!==a.type,b()})},function(a){return a?b(a):b(void 0,c)})}function O(a,b){l(function(c){return c?b(c):db(a)?N($[a],b):b(void 0,!0)})}function P(a,b,c){l(function(d){if(d)return c(d);var e=U[a];return a?(f.waterfall([function(a){return b?(O(e.pageId,a),void 0):a(void 0,!0)},function(b,c){return b?cb(a)?N(Y[a],c):c(void 0,!0):c(void 0,!1)}],c),void 0):c(new Error("Field does not exist in form"))})}function Q(a,b){l(function(c){return c?b(c):(m(a,function(a){if(a)return b(a);var c={};f.parallel([function(a){c.fields={},f.eachSeries(Object.keys(Y),function(a,b){P(a,!1,function(d,e){return d?b(d):(c.fields[a]={targetId:a,action:e?"show":"hide"},b())})},a)},function(a){c.pages={},f.eachSeries(Object.keys($),function(a,b){O(a,function(d,e){return d?b(d):(c.pages[a]={targetId:a,action:e?"show":"hide"},b())})},a)}],function(a){return a?b(a):b(void 0,{actions:c})})}),void 0)})}var R,S,T=b,U={},V={},W={},X={},Y={},Z={},$={},_={},ab={text:z,textarea:z,number:A,emailAddress:B,dropdown:C,radio:D,checkboxes:E,location:G,locationMap:F,photo:I,signature:I,file:I,dateTime:L,sectionBreak:M},bb={text:z,textarea:z,number:A,emailAddress:B,dropdown:C,radio:D,checkboxes:E,location:G,locationMap:F,photo:H,signature:H,file:H,dateTime:L,sectionBreak:M},cb=function(a){return!!Y[a]},db=function(a){return!!$[a]};return{validateForm:o,validateField:r,validateFieldValue:s,checkRules:Q,validateFieldInternal:y,initSubmission:m,isFieldVisible:P,isConditionActive:e}};"undefined"!=typeof d&&d.exports&&(d.exports=l)}(),d.exports(a)}var c=function(a){function b(a,b){var d={updateForms:!0};if("undefined"==typeof b)b=a;else for(var e in a)d[e]=a[e];var f=d.config||{};c.config=c.models.config,c.config.init(f,function(){c.models.uploadManager.loadLocal(function(a){a&&console.error(a),c.models.theme.refresh(!0,function(a){a&&console.error(a),1==d.updateForms?c.models.forms.refresh(!0,function(a){a&&console.error(a),b()}):b()})})})}return a.init=b,a}(c||{});c.utils=function(a){function b(a,b){if(b.constructor&&b.constructor==Function)for(var c in b.prototype)a.prototype[c]=b.prototype[c];else for(var c in b)a.prototype[c]=b[c]}function c(a){var b=new Date;return a?b.getTimezoneOffset():b}function d(a){var b=a.getProps(),d=b._id,e=b._type,f=c().getTime();return d&&e?d+"_"+e+"_"+f:d?d+"_"+f:e?e+"_"+f:f}function e(a,b){"undefined"!=typeof $fh&&$fh.hash?$fh.hash({algorithm:"MD5",text:a},function(a){a&&a.hashvalue?b(null,a.hashvalue):b("Crypto failed.")}):b("Crypto not found")}function f(){var a=-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://");return a?!0:!1}return a.extend=b,a.localId=d,a.md5=e,a.getTime=c,a.isPhoneGap=f,a}(c.utils||{}),c.utils=function(a){function c(){return o}function d(a,b){if(!a instanceof File)throw"Only file object can be used for converting";var c=new FileReader;c.onloadend=function(a){var c=a.target.result;return b(null,c)},c.readAsDataURL(a)}function e(a,c,d){var e=null,f=0;if("object"==typeof c)if(c instanceof File)e=c,f=e.size;else if(c instanceof Blob)e=c,f=b.size;else{var g=JSON.stringify(c),f=g.length;e=new Blob(g,{type:"text/plain"})}else"string"==typeof c&&(f=c.length,e=new Blob([c],{type:"text/plain"}));l(a,f,{create:!0},function(a,b){a?(console.error(a),d(a)):b.createWriter(function(a){function b(a){return d(null,a)}function c(){a.onwriteend=b,a.write(e)}a.onwriteend=c,a.truncate(0)},function(a){d("Failed to create file write:"+a)})})}function f(a,b){l(a,0,{},function(a,c){return a?"NotFoundError"!=a.name&&1!=a.code?b(a):b(null,null):(c.remove(function(){b(null,null)},function(a){b("Failed to remove file"+a)}),void 0)})}function g(a,b){k(a,function(a,c){if(a)b(a);else{var d=new FileReader;d.onloadend=function(a){var c=a.target.result;try{c=decodeURIComponent(c)}catch(d){}return b(null,c)},d.readAsText(c)}})}function h(a,b){k(a,function(a,c){if(a)return b(a);var d=new FileReader;d.onloadend=function(a){var c=a.target.result;return b(null,c)},d.readAsDataURL(c)})}function i(a,b){k(a,function(a,c){if(a)return b(a);var d=c.type,e=new FileReader;e.onloadend=function(a){var c=a.target.result,e=new Blob([c],{type:d});b(null,e)},e.readAsArrayBuffer(c)})}function j(a,b){k(a,b)}function k(a,b){l(a,0,{},function(a,c){return a?b(a):(c.file(function(a){b(null,a)},function(a){console.error("Failed to get file:"+a),b(a)}),void 0)})}function l(a,b,c,d){p(q,b,function(e){e.root.getFile(a,c,function(a){d(null,a)},function(e){if("QuotaExceededError"==e.name||10==e.code){var f=1073741824;m(f,function(){l(a,b,c,d)})}else d(e)})},function(){d("Failed to requestFileSystem")})}function m(a,b){navigator.webkitPersistentStorage?navigator.webkitPersistentStorage.requestQuota(a,function(a){b(null,a)},function(a){b(a,0)}):b(null,a)}function n(){window.requestFileSystem?(p=window.requestFileSystem,o=!0):window.webkitRequestFileSystem?(p=window.webkitRequestFileSystem,o=!0):o=!1,window.LocalFileSystem?q=window.LocalFileSystem.PERSISTENT:window.PERSISTENT&&(q=window.PERSISTENT)}a.fileSystem={isFileSystemAvailable:c,save:e,remove:f,readAsText:g,readAsBlob:i,readAsBase64Encoded:h,readAsFile:j,fileToBase64:d};var o=!1,p=function(){},q=1;return n(),a}(c.utils||{}),c.utils=function(a){function b(){return m}function c(){return l}function d(a,b){h(a,b)}function e(){q&&(q.stop(),q=null)}function f(a,b){var c=a.width,d=a.height;l?navigator.camera.getPicture(g(b),b,{quality:100,targetWidth:c,targetHeight:d,saveToPhotoAlbum:!1,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.PNG}):m?k(a,b):b("Your device does not support camera.")}function g(a){return function(b){var c="data:image/png;base64,"+b;a(null,c)}}function h(a,b){var c=a.width,d=a.height;n.width=1024,n.height=768,o.width=c,o.height=d,q?(console.error("Media device was not released."),b("Media device occupied.")):navigator.getUserMedia({video:!0},function(a){n.src=window.URL.createObjectURL(a),q=a,b(null,n)},b)}function i(){navigator.camera&&navigator.camera.getPicture?l=!0:j()?(m=!0,n=document.createElement("video"),n.autoplay="autoplay",o=document.createElement("canvas"),p=o.getContext("2d")):console.error("Cannot detect usable media API. Camera will not run properly on this device.")}function j(){return navigator.getUserMedia?!0:navigator.webkitGetUserMedia?(navigator.getUserMedia=navigator.webkitGetUserMedia,!0):navigator.mozGetUserMedia?(navigator.getUserMedia=navigator.mozGetUserMedia,!0):navigator.msGetUserMedia?(navigator.getUserMedia=navigator.msGetUserMedia,!0):!1}function k(a,b){if(q){p.drawImage(n,0,0,a.width,a.height);var c=o.toDataURL("image/png");e(),b(null,c)}else console.error("Media resource is not available"),b("Resource not available")}a.takePhoto=f,a.isPhoneGapCamAvailable=c,a.isHtml5CamAvailable=b,a.initHtml5Camera=d,a.cancelHtml5Camera=e;var l=!1,m=!1,n=null,o=null,p=null,q=null;return i(),a}(c.utils||{}),c.web=function(a){return a}(c.web||{}),c.web.ajax=function(a){function b(){}function c(a,b){e({url:a,type:"GET",success:function(a){b(null,a)},error:function(a){b(a)}})}function d(a,b,c){var d,f=!1;if("object"==typeof b)if(b instanceof File){f=!0,d=new FormData;var g=b.name;d.append(g,b),b=d}else b=JSON.stringify(b);var h={url:a,type:"POST",data:b,dataType:"json",success:function(a){c(null,a)},error:function(a){c(a)}};0==f&&(h.contentType="application/json"),e(h)}a="undefined"!=typeof $fh&&$fh.__ajax?$fh.__ajax:b,a.get=c,a.post=d;var e=a;return a}(c.web.ajax||{}),c.stores=function(a){function b(a){this.name=a}return a.Store=b,b.prototype.create=function(){throw"Create not implemented:"+this.name},b.prototype.read=function(){throw"Read not implemented:"+this.name},b.prototype.update=function(){throw"Update not implemented:"+this.name},b.prototype.delete=function(){throw"Delete not implemented:"+this.name},b.prototype.upsert=function(){throw"Upsert not implemented:"+this.name},a}(c.stores||{}),c.stores=function(a){function b(){c.stores.Store.call(this,"LocalStorage")}function d(){i()?f.apply({},arguments):e.apply({},arguments)}function e(a,b,c){$fh.data(a,function(c){"undefined"==typeof c&&(c={key:a.key,val:a.val}),"remove"==a.act.toLowerCase()&&b(null,null),b(null,c.val?c.val:null)
},c)}function f(a,b,c){function d(a){return"undefined"!=typeof c?c(a,{}):void 0}function e(a,b){a+=$fh.app_props.appid,g.md5(a,function(c,d){c&&(d=a);var e=d+".txt";return"undefined"==typeof navigator.externalstorage?b(e):(navigator.externalstorage.enable(function(a){var c=e;return a.path&&(c=a.path,c.match(/\/$/)||(c+="/"),c+=e),e=c,b(e)},function(){return b(e)}),void 0)})}function f(a,c){e(a,function(a){h.save(a,c,function(a){a?d(a):b(null,c)})})}function i(a){e(a,function(a){h.remove(a,function(a){a?"NotFoundError"==a.name||1==a.code?b(null,null):d(a):b(null,null)})})}function j(a){e(a,function(a){h.readAsText(a,function(a,c){a?"NotFoundError"==a.name||1==a.code?b(null,null):d(a):b(null,c)})})}return"undefined"==typeof a.act?j(a.key):"save"===a.act?f(a.key,a.val):"remove"===a.act?i(a.key):"load"===a.act?j(a.key):"undefined"!=typeof c?c("Action ["+a.act+"] is not defined",{}):void 0}var g=c.utils,h=g.fileSystem,i=function(){};return c.utils.extend(b,c.stores.Store),b.prototype.create=function(a,b){var c=g.localId(a);a.setLocalId(c),this.update(a,b)},b.prototype.read=function(a,b){var c=a.getLocalId();null!=c?d({act:"load",key:c.toString()},b,b):b(null,null)},b.prototype.update=function(a,b){var c=a.getLocalId(),e=a.getProps(),f=JSON.stringify(e);d({act:"save",key:c.toString(),val:f},b,b)},b.prototype.delete=function(a,b){var c=a.getLocalId();d({act:"remove",key:c.toString()},b,b)},b.prototype.upsert=function(a,b){var c=a.getLocalId();null==c?this.create(a,b):this.update(a,b)},b.prototype.switchFileSystem=function(a){i=function(){return a}},b.prototype.defaultStorage=function(){i=function(){return h.isFileSystemAvailable()}},i=function(){return h.isFileSystemAvailable()},a.localStorage=new b,a}(c.stores||{}),c.stores=function(a){function b(){e.call(this,"MBaaS")}function d(a){var b=a.get("_type"),d=c.config.get("cloudHost"),e=c.config.get("mbaasBaseUrl"),f=c.config.get("formUrls");if(!f[b])throw"type not found to get url:"+b;var g=f[b],h=d+e+g,i={};switch(b){case"form":i.formId=a.get("_id");break;case"formSubmission":i.formId=a.getFormId();break;case"fileSubmission":i.submissionId=a.getSubmissionId(),i.hashName=a.getHashName(),i.fieldId=a.getFieldId();case"base64fileSubmission":i.submissionId=a.getSubmissionId(),i.hashName=a.getHashName(),i.fieldId=a.getFieldId();case"submissionStatus":i.submissionId=a.get("submissionId");case"completeSubmission":i.submissionId=a.get("submissionId")}for(var j in i)h=h.replace(":"+j,i[j]);return h}var e=c.stores.Store;return a.mBaaS=new b,c.utils.extend(b,e),b.prototype.create=function(a,b){var e=d(a);c.web.ajax.post(e,a.getProps(),b)},b.prototype.read=function(a,b){var e=d(a);c.web.ajax.get(e,b)},b.prototype.update=function(){},b.prototype.delete=function(){},b.prototype.completeSubmission=function(a,b){var e=d(a);c.web.ajax.post(e,{},b)},b.prototype.submissionStatus=function(a,b){var e=d(a);c.web.ajax.get(e,b)},a}(c.stores||{}),c.stores=function(a){function b(a,b){d.call(this,"DataAgent"),this.remoteStore=a,this.localStore=b}var d=c.stores.Store;return a.DataAgent=b,a.dataAgent=new b(c.stores.mBaaS,c.stores.localStorage),c.utils.extend(b,d),b.prototype.read=function(a,b){var c=this;this.localStore.read(a,function(d,e){d||!e?(d&&console.error(d),c.refreshRead(a,b)):b(null,e,!1)})},b.prototype.refreshRead=function(a,b){var c=this;this.remoteStore.read(a,function(d,e){d?(console.error(d),b(d)):(a.fromJSON(e),c.localStore.upsert(a,function(){var a=Array.prototype.slice.call(arguments,0);a.push(!0),b.apply({},a)}))})},a}(c.stores||{}),c.models=function(a){function b(a){if(this.props={_id:null,_type:null,_ludid:null},this.utils=c.utils,this.events={},"undefined"!=typeof a)for(var b in a)this.props[b]=a[b];this.touch()}return b.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].indexOf(b)<0&&this.events[a].push(b)},b.prototype.off=function(a,b){this.events[a]&&this.events[a].indexOf(b)>=0&&this.events[a].splice(this.events[a].indexOf(b),1)},b.prototype.emit=function(){var a=Array.prototype.slice.call(arguments,0),b=a.shift(),c=this.events[b];if(c&&c.length>0)for(var d=0;d<c.length;d++){var e=c[d];e.apply(this,a)}},b.prototype.getProps=function(){return this.props},b.prototype.get=function(a,b){return"undefined"==typeof this.props[a]?b:this.props[a]},b.prototype.set=function(a,b){this.props[a]=b},b.prototype.setLocalId=function(a){this.set("_ludid",a)},b.prototype.getLocalId=function(){return this.get("_ludid")},b.prototype.fromJSON=function(a){if("string"==typeof a)this.fromJSONStr(a);else for(var b in a)this.set(b,a[b]);this.touch()},b.prototype.fromJSONStr=function(a){try{var b=JSON.parse(a);this.fromJSON(b)}catch(c){console.error(c)}},b.prototype.touch=function(){this.set("_localLastUpdate",c.utils.getTime())},b.prototype.getLocalUpdateTimeStamp=function(){return this.get("_localLastUpdate")},b.prototype.genLocalId=function(){return c.utils.localId(this)},b.prototype.refresh=function(a,b){function c(a,c){!a&&c?(e.fromJSON(c),b(null,e)):b(a,e)}var d=this.getDataAgent(),e=this;"undefined"==typeof b&&(b=a,a=!1),a?d.refreshRead(this,c):d.read(this,c)},b.prototype.loadLocal=function(a){var b=c.stores.localStorage,d=this;b.read(this,function(b,c){b?a(b):(c&&d.fromJSON(c),a(b,d))})},b.prototype.saveLocal=function(a){var b=c.stores.localStorage;b.upsert(this,a)},b.prototype.clearLocal=function(a){var b=c.stores.localStorage;b.delete(this,a)},b.prototype.getDataAgent=function(){return this.dataAgent||this.setDataAgent(c.stores.dataAgent),this.dataAgent},b.prototype.setDataAgent=function(a){this.dataAgent=a},a.Model=b,a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"config"})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.init=function(a,b){this.set("appId",$fh.app_props.appid),this.set("env",$fh.app_props.mode?$fh.app_props.mode:"dev"),this.set("timeoutTime",3e4);var c=this;$fh.env(function(a){c.set("deviceId",a.uuid)}),this._initMBaaS(),"undefined"==typeof a.submissionRetryAttempts&&(a.submissionRetryAttempts=2),this.fromJSON(a),b()},b.prototype._initMBaaS=function(){var a=$fh.cloud_props,b=$fh.app_props,c=b.host,d=b.mode?b.mode:"dev";a&&a.hosts&&(c=d.indexOf("dev")>-1?a.hosts.debugCloudUrl:a.hosts.releaseCloudUrl),this.set("cloudHost",c),this.set("mbaasBaseUrl","/mbaas");this.get("appId");this.set("formUrls",{forms:"/forms",form:"/forms/:formId",theme:"/forms/theme",formSubmission:"/forms/:formId/submitFormData",fileSubmission:"/forms/:submissionId/:fieldId/:hashName/submitFormFile",base64fileSubmission:"/forms/:submissionId/:fieldId/:hashName/submitFormFileBase64",submissionStatus:"/forms/:submissionId/status",completeSubmission:"/forms/:submissionId/completeSubmission"})},a.config=new b,a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"forms",_ludid:"forms_list",loaded:!1})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.clearAllForms=function(){},b.prototype.isFormUpdated=function(a){var b=a.get("_id"),c=a.getLastUpdate(),d=this.getFormMetaById(b);return d?c!=d.lastUpdatedTimestamp:!1},b.prototype.getFormMetaById=function(a){for(var b=this.get("forms"),c=0;c<b.length;c++){var d=b[c];if(d._id==a)return d}return null},b.prototype.size=function(){return this.get("forms").length},b.prototype.setLocalId=function(){throw"forms id cannot be set programmly"},b.prototype.getFormsList=function(){return this.get("forms")},b.prototype.getFormIdByIndex=function(a){return this.getFormsList()[a]._id},a.forms=new b,a}(c.models||{}),c.models=function(a){function b(a,b){var f=a.rawMode,g=a.rawData,h=a.formId;if(!h)throw"Cannot initialise a form object without an id. id:"+h;if(d.call(this,{_id:h,_type:"form"}),e[h])return b(null,e[h]),e[h];if(f===!0){this.fromJSON(g);try{this.initialise()}catch(i){console.error("Failed to initialise form."),console.error(i)}e[h]=this,b(null,this)}else{var j=a.fromRemote;if("function"!=typeof j&&"function"!=typeof b)throw"a callback function is required for initialising form data. new Form (formId, [isFromRemote], cb)";if("function"==typeof j){var b=j;j=!1}var k=this;this.refresh(j,function(a,d){try{k.initialise()}catch(f){console.error("Failed to initialise form."),console.error(f)}e[h]=d,c.models.forms.isFormUpdated(k)?k.refresh(!0,function(a,c){try{k.initialise()}catch(f){console.error(f),b(a,d)}e[h]=c,b(a,c)}):b(a,d)})}}var d=c.models.Model;a.Form=b;var e={};return c.utils.extend(b,d),b.prototype.getLastUpdate=function(){return this.get("lastUpdatedTimestamp")},b.prototype.initialise=function(){this.initialisePage(),this.initialiseFields(),this.initialiseRules()},b.prototype.initialiseFields=function(){var a=this.getFieldRef();this.fields={};for(var b in a){var d=a[b],e=d.page,f=d.field;if(void 0==e||void 0==f)throw"Corruptted field reference";var g=this.getFieldDefByIndex(e,f);if(!g)throw"Field def is not found.";var h=new c.models.Field(g,this);this.fields[b]=h}},b.prototype.initialiseRules=function(){this.rules={};for(var a,b=this.getPageRules(),d=this.getFieldRules(),e=[],f=0;a=b[f];f++)e.push({type:"page",definition:a});for(var g,f=0;g=d[f];f++)e.push({type:"field",definition:g});for(var h,f=0;h=e[f];f++)for(var i,j=new c.models.Rule(h),k=j.getRelatedFieldId(),l=0;i=k[l];l++)this.rules[i]||(this.rules[i]=[]),this.rules[i].push(j)},b.prototype.getRulesByFieldId=function(a){return this.rules[a]},b.prototype.initialisePage=function(){var a=this.getPagesDef();this.pages=[];for(var b=0;b<a.length;b++){var d=a[b],e=new c.models.Page(d,this);this.pages.push(e)}},b.prototype.getPageModelList=function(){return this.pages},b.prototype.getName=function(){return this.get("name","")},b.prototype.getDescription=function(){return this.get("description","")},b.prototype.getPageRules=function(){return this.get("pageRules",[])},b.prototype.getFieldRules=function(){return this.get("fieldRules",[])},b.prototype.getFieldRef=function(){return this.get("fieldRef",{})},b.prototype.getPagesDef=function(){return this.get("pages",[])},b.prototype.getPageRef=function(){return this.get("pageRef",{})},b.prototype.getFieldModelById=function(a){return this.fields[a]},b.prototype.getFieldDefByIndex=function(a,b){var c=this.getPagesDef(),d=c[a];if(d){var e=d.fields?d.fields:[],f=e[b];if(f)return f}return null},b.prototype.getPageModelById=function(a){var b=this.getPageRef()[a];if("undefined"==typeof b)throw"page id is not found";return this.pages[b]},b.prototype.newSubmission=function(){return c.models.submission.newInstance(this)},b.prototype.getFormId=function(){return this.get("_id")},b.prototype.removeFromCache=function(){e[this.getFormId()]&&delete e[this.getFormId()]},b.prototype.getFileFieldsId=function(){var a=[];for(var b in this.fields){var c=this.fields[b];("file"==c.getType()||"photo"==c.getType()||"signature"==c.getType())&&a.push(b)}return a},b.prototype.getRuleEngine=function(){if(this.rulesEngine)return this.rulesEngine;var a=this.getProps();return this.rulesEngine=new c.RulesEngine(a),this.rulesEngine},a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"fileSubmission",data:a})}var d=c.models.Model;return a.FileSubmission=b,c.utils.extend(b,d),b.prototype.loadFile=function(a){var b=this.getHashName(),d=this;c.utils.fileSystem.readAsFile(b,function(b,c){b?(console.error(b),a(b)):(d.fileObj=c,a(null))})},b.prototype.getProps=function(){return this.fileObj},b.prototype.setSubmissionId=function(a){this.set("submissionId",a)},b.prototype.getSubmissionId=function(){return this.get("submissionId")},b.prototype.getHashName=function(){return this.get("data").hashName},b.prototype.getFieldId=function(){return this.get("data").fieldId},a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"formSubmission",data:a})}var d=c.models.Model;return a.FormSubmission=b,c.utils.extend(b,d),b.prototype.getProps=function(){return this.get("data")},b.prototype.getFormId=function(){return this.get("data").formId},a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"completeSubmission",submissionId:a.get("submissionId"),localSubmissionId:a.get("localSubmissionId")})}var d=c.models.Model;return a.FormSubmissionComplete=b,c.utils.extend(b,d),a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"submissionStatus",submissionId:a.get("submissionId"),localSubmissionId:a.get("localSubmissionId")})}var d=c.models.Model;return a.FormSubmissionStatus=b,c.utils.extend(b,d),a}(c.models||{}),c.models=function(a){function b(a){d.call(this,a),this.set("_type","base64fileSubmission")}var d=c.models.FileSubmission;return a.Base64FileSubmission=b,c.utils.extend(b,d),a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"submissions",_ludid:"submissions_list",submissions:[]})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.setLocalId=function(){throw"It is not allowed to set local id programmly for submissions model."},b.prototype.saveSubmission=function(a,b){this.updateSubmissionWithoutSaving(a),this.saveLocal(b)},b.prototype.updateSubmissionWithoutSaving=function(a){var b=this.pruneSubmission(a),c=b._ludid;if(c){var d=this.findMetaByLocalId(c),e=this.get("submissions");d?(e.splice(e.indexOf(d),1),e.push(b)):e.push(b)}else console.error("Invalid submission:"+JSON.stringify(a))},b.prototype.findByFormId=function(a){for(var b=[],c=this.get("submissions"),d=0;d<c.length;d++){var e=c[d];c[d].formId==a&&b.push(e)}return b},b.prototype.getSubmissions=function(){return this.get("submissions")},b.prototype.getSubmissionMetaList=b.prototype.getSubmissions,b.prototype.findMetaByLocalId=function(a){for(var b=this.get("submissions"),c=0;c<b.length;c++){var d=b[c];if(b[c]._ludid==a)return d}return null},b.prototype.pruneSubmission=function(a){for(var b=["_id","_ludid","status","formName","formId","_localLastUpdate","createDate","submitDate","deviceFormTimestamp","errorMessage","submissionStartedTimestamp","submitDate"],c=a.getProps(),d={},e=0;e<b.length;e++){var f=b[e];d[f]=c[f]}return d},b.prototype.validateBeforeSubmission=function(){return!0},b.prototype.clear=function(a){var b=this;this.clearLocal(function(c){c?(console.error(c),a(c)):(b.set("submissions",[]),a(null,null))})},b.prototype.getDrafts=function(){return this.findByStatus("draft")},b.prototype.getPending=function(){return this.findByStatus("pending")},b.prototype.getSubmitted=function(){return this.findByStatus("submitted")},b.prototype.getError=function(){return this.findByStatus("error")},b.prototype.getInProgress=function(){return this.findByStatus("inprogress")},b.prototype.findByStatus=function(a){for(var b=this.get("submissions"),c=[],d=0;d<b.length;d++)b[d].status==a&&c.push(b[d]);return c},b.prototype.getSubmissionByMeta=function(a,b){var d=a._ludid;if(!d)throw"local id not found for retrieving submission.";c.models.submission.fromLocal(d,b)},b.prototype.removeSubmission=function(a,b){var c=this.indexOf(a);c>-1&&this.get("submissions").splice(c,1),this.saveLocal(b)},b.prototype.indexOf=function(a){for(var b=this.get("submissions"),c=0;c<b.length;c++){{b[c]}if(b[c]._ludid==a)return c}return-1},a.submissions=new b,a}(c.models||{}),c.models=function(a){function b(a){return new e(a)}function d(a,b){if(f[a])b(null,f[a]);else{var c=new e;c.setLocalId(a),c.loadLocal(function(c,d){c?b(c):d.reloadForm(function(c){c?b(c):(f[a]=d,b(null,d))})})}}function e(a){g.call(this,{_type:"submission"}),"undefined"!=typeof a&&a&&(this.set("formName",a.get("name")),this.set("formId",a.get("_id")),this.set("deviceFormTimestamp",a.getLastUpdate()),this.form=a),this.set("status","new"),this.set("createDate",c.utils.getTime()),this.set("timezoneOffset",c.utils.getTime(!0)),this.set("appId",c.config.get("appId")),this.set("appEnvironment",c.config.get("env")),this.set("appCloudName",""),this.set("comments",[]),this.set("formFields",[]),this.set("saveDate",null),this.set("submitDate",null),this.set("uploadStartDate",null),this.set("submittedDate",null),this.set("userId",null),this.set("filesInSubmission",{}),this.set("deviceId",c.models.config.get("deviceId")),this.transactionMode=!1,this.genLocalId();var b=this.getLocalId();f[b]=this}a.submission={newInstance:b,fromLocal:d};var f={},g=c.models.Model,h={"new":["draft","pending"],draft:["pending","draft"],pending:["inprogress"],inprogress:["submitted","pending","error","inprogress"],submitted:[],error:["draft","pending","inprogress","error"]};return c.utils.extend(e,g),e.prototype.saveDraft=function(a){var b="draft",d=this;this.set("timezoneOffset",c.utils.getTime(!0)),this.set("saveDate",c.utils.getTime()),this.changeStatus(b,function(b){return b?a(b):(d.emit("savedraft"),a(null,null),void 0)})},e.prototype.validateField=function(a,b){var c=this;this.getForm(function(d,e){if(d)b(d);else{var f=c.getProps(),g=e.getRuleEngine();g.validateField(a,f,b)}})},e.prototype.checkRules=function(a){var b=this;this.getForm(function(c,d){if(c)a(c);else{var e=b.getProps(),f=d.getRuleEngine();f.checkRules(e,a)}})},e.prototype.submit=function(a){var b="pending",d=this;this.set("timezoneOffset",c.utils.getTime(!0)),this.getForm(function(c,e){var f=e.getRuleEngine(),g=d.getProps();f.validateForm(g,function(c,e){if(c)a(c);else{var f=e.validation;f.valid?(d.set("submitDate",new Date),d.changeStatus(b,function(b){b?a(b):(d.emit("submit"),a(null,null))})):(a("Validation error"),d.emit("validationerror",f))}})})},e.prototype.getUploadTask=function(a){var b=this.getUploadTaskId();b?c.models.uploadManager.getTaskById(b,a):a(null,null)},e.prototype.cancelUploadTask=function(a){var b="submit",d=this;c.models.uploadManager.cancelSubmission(this,function(c){c&&console.error(c),d.changeStatus(b,a)})},e.prototype.getUploadTaskId=function(){return this.get("uploadTaskId")},e.prototype.setUploadTaskId=function(a){this.set("uploadTaskId",a)},e.prototype.submitted=function(a){var b="submitted",d=this;this.set("submittedDate",c.utils.getTime()),this.changeStatus(b,function(b){b?a(b):(d.emit("submitted"),a(null,null))})},e.prototype.genLocalId=function(){var a=c.utils.localId(this),b=this.get("formId")||Math.ceil(1e5*Math.random());this.setLocalId(b+"_"+a)},e.prototype.changeStatus=function(a,b){if(!this.isStatusValid(a))throw"Target status is not valid: "+a;this.set("status",a),this.saveToList(function(a){a&&console.log(a)}),this.saveLocal(b)},e.prototype.upload=function(a){var b="inprogress",d=this;return this.isStatusValid(b)?(this.set("status",b),this.set("uploadStartDate",c.utils.getTime()),c.models.submissions.updateSubmissionWithoutSaving(this),c.models.uploadManager.queueSubmission(this,function(b,c){b?a(b):(c.set("error",null),c.saveLocal(function(a){a&&console.log(a)}),d.emit("inprogress",c),a(null,c))}),void 0):a("Invalid Status to upload a form submission.")},e.prototype.saveToList=function(a){c.models.submissions.saveSubmission(this,a)},e.prototype.error=function(a,b){this.set("errorMessage",a);var c="error";this.changeStatus(c,b),this.emit("submitted",a)},e.prototype.getStatus=function(){return this.get("status")},e.prototype.isStatusValid=function(a){var b=this.get("status").toLowerCase(),c=h[b];return c.indexOf(a)>-1?!0:!1},e.prototype.addComment=function(a,b){var d=c.utils.getTime(),e=d.getTime(),f={madeBy:"undefined"==typeof b?"":b.toString(),madeOn:d,value:a,timeStamp:e};return this.getComments().push(f),e},e.prototype.getComments=function(){return this.get("comments")},e.prototype.removeComment=function(a){for(var b=this.getComments(),c=0;c<b.length;c++){var d=b[c];if(d.timeStamp==a)return b.splice(c,1),void 0}},e.prototype.addSubmissionFile=function(a){var b=this.get("filesInSubmission",{});b[a]=!0,this.set("filesInSubmission",b),this.saveLocal(function(a){a&&console.error(a)})},e.prototype.addInputValue=function(a,b){var c=this,d=a.fieldId,e=(a.value,void 0===a.index?-1:a.index);this.getForm(function(f,g){var h=g.getFieldModelById(d);if(c.transactionMode)c.tmpFields[d]||(c.tmpFields[d]=[]),h.processInput(a,function(a,f){a?b(a):(e>-1?c.tmpFields[d][e]=f:c.tmpFields[d].push(f),"object"==typeof f&&f.hashName&&c.addSubmissionFile(f.hashName),b(null,f))});else{var i=c.getInputValueObjectById(d);h.processInput(a,function(a,d){a?b(a):(e>-1?i.fieldValues[e]=d:i.fieldValues.push(d),"object"==typeof d&&d.hashName&&c.addSubmissionFile(d.hashName),b(null,d))})}})},e.prototype.getInputValueByFieldId=function(a,b){var c=this.getInputValueObjectById(a).fieldValues;this.getForm(function(d,e){var f=e.getFieldModelById(a);f.convertSubmission(c,b)})},e.prototype.reset=function(){this.set("formFields",[])},e.prototype.clearLocalSubmissionFiles=function(a){var b=this.get("filesInSubmission",{});for(var d in b)c.utils.fileSystem.remove(d,function(a){a&&console.error(a)});a()},e.prototype.startInputTransaction=function(){this.transactionMode=!0,this.tmpFields={}},e.prototype.endInputTransaction=function(a){if(this.transactionMode=!1,a){var b=(this.get("formFields"),this.tmpFields);for(var c in b)for(var d=this.getInputValueObjectById(c),e=b[c],f=0;f<e.length;f++){var g=e[f];d.fieldValues.push(g)}this.tmpFields={}}else this.tmpFields={}},e.prototype.removeFieldValue=function(a,b){var c=[];c=this.transactionMode?this.tmpFields.fieldId:this.getInputValueObjectById(a).fieldId,"undefined"==typeof b?c.splice(0,c.length):c.length>b&&c.splice(b,1)},e.prototype.getInputValueObjectById=function(a){for(var b=this.get("formFields",[]),c=0;c<b.length;c++){var d=b[c];if(d.fieldId==a)return d}var e={fieldId:a,fieldValues:[]};return b.push(e),e},e.prototype.getForm=function(a){var b=c.models.Form,d=this.get("formId");new b({formId:d},a)},e.prototype.reloadForm=function(a){var b=c.models.Form,d=this.get("formId"),e=this;new b({formId:d},function(b,c){b?a(b):(e.form=c,e.get("deviceFormTimestamp",null)||e.set("deviceFormTimestamp",c.getLastUpdate()),a(null,c))})},e.prototype.getFileInputValues=function(){var a=this.form.getFileFieldsId();return this.getInputValueArray(a)},e.prototype.getInputValueArray=function(a){for(var b,c=[],d=0;b=a[d];d++)for(var e=this.getInputValueObjectById(b),f=0;f<e.fieldValues.length;f++){var g=e.fieldValues[f];g&&(g.fieldId=b,c.push(g))}return c},e.prototype.clearLocal=function(a){var b=this;c.models.uploadManager.cancelSubmission(b,function(d){return d?(console.error(d),a(d)):(c.models.submissions.removeSubmission(b.getLocalId(),function(c){return c?(console.err(c),a(c)):(b.clearLocalSubmissionFiles(function(){g.prototype.clearLocal.call(b,function(b){return b?(console.error(b),a(b)):(a(null,null),void 0)})}),void 0)}),void 0)})},a}(c.models||{}),c.models=function(a){function b(a,b){d.call(this,{_type:"field"}),a&&(this.fromJSON(a),this.genLocalId()),b&&(this.form=b)}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.isRequired=function(){return this.get("required")},b.prototype.getFieldValidation=function(){return this.getFieldOptions().validation||{}},b.prototype.getFieldDefinition=function(){return this.getFieldOptions().definition||{}},b.prototype.getMinRepeat=function(){var a=this.getFieldDefinition();return a.minRepeat||1},b.prototype.getMaxRepeat=function(){var a=this.getFieldDefinition();return a.maxRepeat||1},b.prototype.getFieldOptions=function(){return this.get("fieldOptions",{validation:{},definition:{}})},b.prototype.isRepeating=function(){return this.get("repeating",!1)},b.prototype.getType=function(){return this.get("type","text")},b.prototype.getFieldId=function(){return this.get("_id","")},b.prototype.getName=function(){return this.get("name","unknown name")},b.prototype.getHelpText=function(){return this.get("helpText","")},b.prototype.processInput=function(a,b){var c=this.getType(),d="process_"+c,e=a.value;return"undefined"==typeof e||null===e?b(null,e):(this[d]&&"function"==typeof this[d]?this[d](a,b):b(null,e),void 0)},b.prototype.convertSubmission=function(a,b){var c=this.getType(),d="convert_"+c;this[d]&&"function"==typeof this[d]?this[d](a,b):b(null,a)},b.prototype.validate=function(a,b){this.form.getRuleEngine().validateFieldValue(this.getFieldId(),a,b)},b.prototype.getRules=function(){var a=this.getFieldId();return this.form.getRulesByFieldId(a)},b.prototype.setVisible=function(a){this.set("visible",a),a?this.emit("visible"):this.emit("hidden")},a.Field=b,a}(c.models||{}),c.models.Field=function(a){return a.prototype.getCheckBoxOptions=function(){var a=this.getFieldDefinition();if(a.options)return a.options;throw"checkbox choice definition is not found in field definition"},a.prototype.process_checkboxes=function(a,b){var c=a.value;if(c instanceof Array){var d={selections:c};b(null,d)}else b("the input value for processing checkbox field should be like [val1,val2]")},a.prototype.convert_checkboxes=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d].selections);b(null,c)},a}(c.models.Field||{}),c.models.Field=function(a){function b(a){return a.fileName&&a.fileType&&a.hashName}return a.prototype.process_file=function(a,d){var e=a.value,f=void 0===a.isStore?!0:a.isStore;if("undefined"==typeof e||null==e)return d(null,null);if("object"!=typeof e||!e instanceof HTMLInputElement&&!e instanceof File&&!b(e))throw"the input value for file field should be a html file input element or a File object";if(b(e))return d(null,e);var g=e;e instanceof HTMLInputElement&&(g=e.files[0]);var h={fileName:g.name,fileSize:g.size,fileType:g.type,fileUpdateTime:g.lastModifiedDate.getTime(),hashName:"",contentType:"binary"},i=g.name+(new Date).getTime()+Math.ceil(1e5*Math.random());c.utils.md5(i,function(a,b){var e=b;a&&(e=i),e="filePlaceHolder"+e,h.hashName=e,f?c.utils.fileSystem.save(e,g,function(a){a?(console.error(a),d(a)):d(null,h)}):d(null,h)})},a}(c.models.Field||{}),c.models.Field=function(a){return a.prototype.process_location=function(a,b){var c=a.value,d=this.getFieldDefinition();switch(d.locationUnit){case"latLong":if(c.lat&&c["long"]){var e={lat:c.lat,"long":c.long};b(null,e)}else b("the input values for latlong field is {lat: number, long: number}");break;case"northEast":if(c.zone&&c.eastings&&c.northings){var e={zone:c.zone,eastings:c.eastings,northings:c.northings};b(null,e)}else b("the input values for northeast field is {zone: text, eastings: text, northings:text}")}},a}(c.models.Field||{}),c.models.Field=function(a){return a.prototype.getMatrixRows=function(){var a=this.getFieldDefinition();if(a.rows)return a.rows;throw"matrix rows definition is not found in field definition"},a.prototype.getMatrixCols=function(){var a=this.getFieldDefinition();if(a.columns)return a.columns;throw"matrix columns definition is not found in field definition"},a}(c.models.Field||{}),c.models.Field=function(a){return a.prototype.getRadioOption=function(){var a=this.getFieldDefinition();if(a.options)return a.options;throw"Radio options definition is not found in field definition"},a}(c.models.Field||{}),c.models.Field=function(a){function b(a,b){var e=a.value,f=void 0===a.isStore?!0:a.isStore;if(""==e)return b(null,null);var g="",h=e.split(";base64,"),i=h[0].split(":")[1],j=i.split("/")[1],k=e.length;d(function(a,d){g="filePlaceHolder"+d;var e={fileName:g+"."+j,hashName:g,contentType:"base64",fileSize:k,fileType:i,imgHeader:"data:"+i+";base64,",fileUpdateTime:(new Date).getTime()};f?c.utils.fileSystem.save(g,h[1],function(a){a?(console.error(a),b(a)):b(null,e)}):b(null,e)})}function d(a){var b=(new Date).getTime()+""+Math.ceil(1e5*Math.random());c.utils.md5(b,a)}function e(a,b){if(0==a.length)b(null,a);else for(var c=a.length,d=0;d<a.length;d++){var e=a[d];f(e,function(){c--,0==c&&b(null,a)})}}function f(a,b){if(a){var d=a.hashName;c.utils.fileSystem.readAsText(d,function(c,d){c&&console.error(c),a.data=d,b(c,a)})}else b(null,a)}return a.prototype.process_signature=b,a.prototype.convert_signature=e,a.prototype.process_photo=b,a.prototype.convert_photo=e,a}(c.models.Field||{}),c.models=function(a){function b(a,b){if("undefined"==typeof a||"undefined"==typeof b)throw"Page initialise failed: new Page(pageDefinitionJSON, parentFormModel)";d.call(this,{_type:"page"}),this.fromJSON(a),this.form=b,this.initialise()}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.initialise=function(){var a=this.getFieldDef();this.fieldsIds=[];for(var b=0;b<a.length;b++)this.fieldsIds.push(a[b]._id)},b.prototype.setVisible=function(a){this.set("visible",a),a?this.emit("visible"):this.emit("hidden")},b.prototype.getName=function(){return this.get("name","")},b.prototype.getDescription=function(){return this.get("description","")},b.prototype.getFieldDef=function(){return this.get("fields",[])},b.prototype.getFieldModelList=function(){for(var a=[],b=0;b<this.fieldsIds.length;b++)a.push(this.form.getFieldModelById(this.fieldsIds[b]));return a},b.prototype.getFieldModelById=function(a){return this.form.getFieldModelById(a)},b.prototype.getPageId=function(){return this.get("_id","")},a.Page=b,a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"fieldvalidate"})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.validate=function(a,b){var c=(b.isRequired(),b.getFieldValidation());for(var d in c){if(this[d]&&"function"==typeof this[d]){var e=this[d](a,c[d]);if(e===!0)continue;return e}console.error("Validation method is not found:"+d)}return!0},b.prototype.min=function(a,b){return a>=b?!0:"Min value is "+b+" while input value is "+a},b.prototype.max=function(a,b){return b>=a?!0:"Max value is "+b+" while input value is "+a},b.prototype.minSelected=function(a,b){return"array"==typeof a&&a.length>=b?!0:"Min selected number is "+b},b.prototype.maxSelected=function(a,b){return"array"==typeof a&&a.length<=b?!0:"Max selected number is "+b},a.fieldValidate=new b,a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"uploadManager",_ludid:"uploadManager_queue"}),this.set("taskQueue",[]),this.timeOut=60,this.sending=!1,this.timerInterval=200,this.sendingStart=c.utils.getTime()}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.queueSubmission=function(a,b){var d,e=null,f=this;a.getUploadTaskId()?d=a.getUploadTaskId():(e=c.models.uploadTask.newInstance(a),d=e.getLocalId()),this.push(d),this.timer||this.start(),e?e.saveLocal(function(c){c&&console.error(c),f.saveLocal(function(c){c&&console.error(c),a.setUploadTaskId(d),b(null,e)})}):f.getTaskById(d,b)},b.prototype.cancelSubmission=function(a,b){var c=a.getUploadTaskId(),d=this.get("taskQueue");if(c){var e=d.indexOf(c);e>-1&&d.splice(e,1),this.getTaskById(c,function(a,c){a?(console.error(a),b(a,c)):c?c.clearLocal(b):b(null,null)}),this.saveLocal(function(a){a&&console.log(a)})}else b(null,null)},b.prototype.getTaskQueue=function(){return this.get("taskQueue",[])},b.prototype.start=function(){var a=this;this.stop(),this.timer=setInterval(function(){a.tick()},this.timerInterval)},b.prototype.stop=function(){this.timer&&(clearInterval(this.timer),this.timer=null)},b.prototype.push=function(a){this.get("taskQueue").push(a),this.saveLocal(function(a){a&&console.log(a)})},b.prototype.shift=function(){var a=this.get("taskQueue").shift();return this.saveLocal(function(a){a&&console.log(a)}),a},b.prototype.rollTask=function(){this.push(this.shift())},b.prototype.tick=function(){if(this.sending){var a=c.utils.getTime(),b=a.getTime()-this.sendingStart.getTime();b>1e3*this.timeOut&&(console.error("Uploading content timeout. it will try to reupload."),this.sending=!1,this.rollTask())}else if(this.hasTask()){this.sending=!0,this.sendingStart=c.utils.getTime();var d=this;this.getCurrentTask(function(a,b){a||!b?(console.error(a),d.sending=!1):b.isCompleted()||b.isError()?(d.shift(),d.sending=!1,d.saveLocal(function(){})):b.uploadTick(function(){d.sending=!1})})}else this.stop()},b.prototype.hasTask=function(){return this.get("taskQueue").length>0},b.prototype.getCurrentTask=function(a){var b=this.getTaskQueue()[0];b?this.getTaskById(b,a):a(null,null)},b.prototype.getTaskById=function(a,b){c.models.uploadTask.fromLocal(a,b)},a.uploadManager=new b,a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"rule"}),this.fromJSON(a)}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.getRelatedFieldId=function(){for(var a,b=this.getDefinition(),c=b.ruleConditionalStatements,d=[],e=0;a=c[e];e++)d.push(a.sourceField);
return d},b.prototype.test=function(a){for(var b,c=this.getRelatedFieldId(),d=this.getLogic(),e="or"==d?!1:!0,f=0;b=c[f];f++){var g=a[b];if(g){var h=this.testField(b,g);if("or"==d){if(e=e||h,1==e)return!0}else if(e=e&&h,0==e)return!1}else{if("or"!=d)return!1;e=e||!1}}return e},b.prototype.testField=function(a,b){var d=this.getRuleConditionStatement(a),e=d.restriction,f=d.sourceValue;return c.models.checkRule(e,f,b)},b.prototype.getRuleConditionStatement=function(a){for(var b,c=this.getDefinition().ruleConditionalStatements,d=0;b=c[d];d++)if(b.sourceField==a)return b;return null},b.prototype.getLogic=function(){var a=this.getDefinition();return a.ruleConditionalOperator.toLowerCase()},b.prototype.getDefinition=function(){return this.get("definition")},b.prototype.getAction=function(){var a=this.getDefinition(),b={action:a.type,targetId:"page"==this.get("type")?a.targetPage:a.targetField,targetType:this.get("type")};return b},a.Rule=b,a}(c.models||{}),c.models=function(a){function b(a,b,d){var e=a.toLowerCase().replace(/\s/g,"_"),f=c[e];return f?f(b,d):(console.error("Rule func not found:"+e),!1)}a.checkRule=b;var c={is_not:function(a,b){return a!=b},is_equal_to:function(a,b){return a==b},is_greater_than:function(a,b){return b>a},is_less_than:function(a,b){return a>b},is_on:function(a,b){try{return new Date(a).getTime()==new Date(b).getTime()}catch(c){return console.error(c),!1}},is_before:function(a,b){try{return new Date(a).getTime()>new Date(b).getTime()}catch(c){return console.error(c),!1}},is_after:function(a,b){try{return new Date(a).getTime()<new Date(b).getTime()}catch(c){return console.error(c),!1}},is:function(a,b){return a==b},contains:function(a,b){return b.toString().indexOf(a.toString())>-1},does_not_contain:function(a,b){return-1==b.toString().indexOf(a.toString())},begins_with:function(a,b){return 0==b.toString().indexOf(a.toString())},ends_with:function(a,b){return b.toString().length==b.toString().indexOf(a.toString())+a.toString().length}};return a}(c.models||{}),c.models=function(a){function b(a){var b=new e;return b.init(a),f[b.getLocalId()]=b,b}function d(a,b){if(f[a])return b(null,f[a]);var c=new e;c.setLocalId(a),f[a]=c,c.loadLocal(b)}function e(){g.call(this,{_type:"uploadTask"})}a.uploadTask={newInstance:b,fromLocal:d};var f={},g=c.models.Model;return c.utils.extend(e,g),e.prototype.init=function(a){var b=a.getProps(),c=a.getFileInputValues(),d=a.getLocalId();this.setLocalId(d+"_uploadTask"),this.set("submissionLocalId",d),this.set("jsonTask",b),this.set("fileTasks",[]),this.set("currentTask",null),this.set("completed",!1),this.set("mbaasCompleted",!1),this.set("retryAttempts",0),this.set("retryNeeded",!1),this.set("formId",a.get("formId"));for(var e,f=0;e=c[f];f++)this.addFileTask(e)},e.prototype.getTotalSize=function(){for(var a,b=JSON.stringify(this.get("jsonTask")).length,c=this.get("fileTasks"),d=0,e=0;a=c[e];e++)d+=a.fileSize;return b+d},e.prototype.getUploadedSize=function(){var a=this.getCurrentTask();if(null===a)return 0;for(var b,c=JSON.stringify(this.get("jsonTask")).length,d=this.get("fileTasks"),e=0,f=0;(b=d[f])&&a>f;f++)e+=b.fileSize;return c+e},e.prototype.getRemoteStore=function(){return c.stores.mBaaS},e.prototype.addFileTask=function(a){this.get("fileTasks").push(a)},e.prototype.getCurrentTask=function(){return this.get("currentTask",null)},e.prototype.getRetryAttempts=function(){return this.get("retryAttempts")},e.prototype.increRetryAttempts=function(){this.set("retryAttempts",this.get("retryAttempts")+1)},e.prototype.resetRetryAttempts=function(){this.set("retryAttempts",0)},e.prototype.isStarted=function(){return null==this.getCurrentTask()?!1:!0},e.prototype.uploadForm=function(a){var b=this.get("jsonTask"),d=this,e=new c.models.FormSubmission(b);this.getRemoteStore().create(e,function(e,f){if(e)a(e);else{var g=f.submissionId,h=f.updatedFormDefinition;if(!h)return b.lastUpdate=c.utils.getTime(),d.set("submissionId",g),d.increProgress(),d.saveLocal(function(a){a&&console.error(a)}),d.emit("progress",d.getProgress()),a(null);d.refreshForm(function(a){a&&console.error(a)});var e="Form definition is out of date.";a(e)}})},e.prototype.handleCompletionError=function(a,b,c){var d=a;d="pending"===b.status?"Submission Still Pending.":"error"===b.status?"Error completing submission":"Invalid return type from complete submission",c(d)},e.prototype.handleIncompleteSubmission=function(a){var b=this.getRemoteStore(),d=new c.models.FormSubmissionStatus(this),e=this;b.submissionStatus(d,function(b,c){if(b)a(b);else if("error"===c.status){var d="Error submitting form.";a(d)}else if("complete"===c.status)e.increProgress(),a();else if("pending"===c.status){var f=c.pendingFiles||[];f.length>0?e.resetUploadTask(f,function(){a()}):(e.increProgress(),a())}else{var d="Invalid submission status response.";a(d)}})},e.prototype.resetUploadTask=function(a,b){for(var c=this.get("fileTasks"),d=[],e=0;e<c.length;e++)a.indexOf(c[e].hashName)<0&&d.push(c[e]);for(var e=0;e<c.length;e++)a.indexOf(c[e].hashName)>-1&&d.push(c[e]);var f=c.length-a.length-1,g=0;f>0&&(g=f),this.set("currentTask",g),this.set("fileTasks",d),this.saveLocal(b)},e.prototype.uploadFile=function(a){var b=this,d=this.get("submissionId");if(d){var e=this.getCurrentTask();null==e&&(e=0,b.set("currentTask",e));var f=this.get("fileTasks",[])[e];if(!f)return a("cannot find file task");var g;g="base64"==f.contentType?new c.models.Base64FileSubmission(f):new c.models.FileSubmission(f),g.setSubmissionId(d),g.loadFile(function(d){return d?a(d):(b.getRemoteStore().create(g,function(d,e){if(d)a(d);else if("ok"==e.status||"200"==e.status)f.updateDate=c.utils.getTime(),b.increProgress(),b.saveLocal(function(a){a&&console.error(a)}),b.emit("progress",b.getProgress()),a(null);else{var g="File upload failed for file: "+f.fileName;a(g)}}),void 0)})}else a("Failed to upload file. Submission Id not found.")},e.prototype.setRetryNeeded=function(a){null!=this.get("submissionId",null)?this.set("retryNeeded",a):(this.set("retryNeeded",!1),this.set("currentTask",null))},e.prototype.retryNeeded=function(){return this.get("retryNeeded")},e.prototype.uploadTick=function(a){function b(b){b?(console.log("Err, retrying:",b),d.increRetryAttempts(),d.getRetryAttempts()<=c.config.get("submissionRetryAttempts")?(d.setRetryNeeded(!0),d.saveLocal(function(b){b&&console.log(b),a()})):(d.setRetryNeeded(!0),d.resetRetryAttempts(),d.error(b,function(){a(b)}))):(d.setRetryNeeded(!1),d.saveLocal(function(a){a&&console.log(a)}),d.submissionModel(function(b,c){if(b)a(b);else{var d=c.get("status");"inprogress"!=d&&"submitted"!=d?a("Submission status is incorrect. Upload task should be started by submission object's upload method."):a()}}))}var d=this;this.isFormCompleted()?this.retryNeeded()?this.handleIncompleteSubmission(b):this.isFileCompleted()?this.isMBaaSCompleted()?this.isCompleted()?b(null,null):this.success(b):this.uploadComplete(b):this.uploadFile(b):this.uploadForm(b)},e.prototype.increProgress=function(){var a=this.getCurrentTask();null===a?a=0:a++,this.set("currentTask",a)},e.prototype.uploadComplete=function(a){var b=this.get("submissionId",null),d=this;if(null===b)return a("Failed to complete submission. Submission Id not found.");var e=this.getRemoteStore(),f=new c.models.FormSubmissionComplete(this);e.create(f,function(b,c){return c=c||{},"complete"!==c.status?d.handleCompletionError(b,c,a):(d.increProgress(),a(null),void 0)})},e.prototype.success=function(a){this.set("completed",!0),this.saveLocal(function(a){a&&(console.error(a),console.error("Upload task save failed"))}),this.submissionModel(function(b,c){b?a(b):c.submitted(a)})},e.prototype.error=function(a,b){this.set("error",a),this.saveLocal(function(a){a&&(console.error(a),console.error("Upload task save failed"))}),this.submissionModel(function(c,d){c?b(c):(d.error(a,function(){}),b(a))})},e.prototype.isFormCompleted=function(){var a=this.getCurrentTask();return null===a?!1:!0},e.prototype.isFileCompleted=function(){var a=this.getCurrentTask();return null===a?!1:a<this.get("fileTasks",[]).length?!1:!0},e.prototype.isError=function(){var a=this.get("error",null);return a?!0:!1},e.prototype.isCompleted=function(){return this.get("completed",!1)},e.prototype.isMBaaSCompleted=function(){if(this.isFileCompleted()){var a=this.getCurrentTask();return a>this.get("fileTasks",[]).length?!0:!1}return!1},e.prototype.getProgress=function(){var a={formJSON:!1,currentFileIndex:0,totalFiles:this.get("fileTasks").length,totalSize:this.getTotalSize(),uploaded:this.getUploadedSize(),retryAttempts:this.getRetryAttempts()},b=this.getCurrentTask();return null===b?a:(a.formJSON=!0,a.currentFileIndex=b,a)},e.prototype.refreshForm=function(a){var b=this.get("formId");new c.models.Form({formId:b},function(b,c){b&&console.error(b),c.refresh(!0,function(b){b&&console.error(b),a()})})},e.prototype.submissionModel=function(a){c.models.submission.fromLocal(this.get("submissionLocalId"),function(b,c){b&&console.error(b),a(b,c)})},a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"theme",_ludid:"theme_object"})}var d=c.models.Model;return b.prototype.getCSS=function(){return this.get("css","")},c.utils.extend(b,d),a.theme=new b,a}(c.models||{}),c.api=function(a){function b(a,b){var d=a.fromRemote;void 0==d&&(d=!1),c.models.forms.refresh(d,b)}function d(a,b){new c.models.Form(a,b)}function e(a,b){var d=c.models.theme;a.fromRemote||(a.fromRemote=!1),d.refresh(a.fromRemote,function(c,e){return c?b(c):null===e?b(new Error("No theme defined for this app")):a.css===!0?b(null,d.getCSS()):b(null,d)})}function f(a,b){c.models.submissions;null==h?c.models.submissions.loadLocal(function(a){a?(console.error(a),b(a)):(h=c.models.submissions,b(null,h))}):setTimeout(function(){b(null,h)},0)}function g(a,b){return a?(a.submit(function(c){return c?b(c):(a.upload(b),void 0)}),void 0):b("Invalid submission object.")}a.getForms=b,a.getForm=d,a.getTheme=e,a.submitForm=g,a.getSubmissions=f,a.init=c.init,a.config=c.models.config;var h=null;return a}(c.api||{}),"undefined"==typeof $fh&&($fh={}),void 0==$fh.forms&&($fh.forms=c.api),c.RulesEngine=a}(window||module.exports);