var chai = require('chai');
var expect = chai.expect;
var sinonChai = require('sinon-chai');
chai.use(sinonChai);

var fhconfig = {
  "host": "http://localhost:8100",
  "appid" : "testappid",
  "appkey" : "testappkey",
  "mode": "dev"
}

var legacyAppHost = {
  domain: "testing",
  firstTime: false,
  hosts: {
    "releaseCloudUrl": "http://localhost:8102",
    "releaseCloudType": "fh",
    "debugCloudUrl": "http://localhost:8103",
    "debugCloudType": "fh"
  },
  init: {
    "trackId": "testtrackid"
  }
}

var buildFakeRes = function(data){
  return [200, {"Content-Type": "application/json"}, JSON.stringify(data)];
}

var initFakeServer = function(server){
   server.respondWith('GET', /fhconfig.json/, buildFakeRes(fhconfig));

   server.respondWith('POST', /init/, buildFakeRes(legacyAppHost));
}

describe("test legacy app props/app init", function(){
  var server;

  beforeEach(function () { server = sinon.fakeServer.create(); });
  afterEach(function () { server.restore(); });

  describe("test legacy app init", function(){
    it("$fh.init should initialise the app", function(){
      var callback = sinon.spy();

      server.respondWith('POST', /init/, buildFakeRes(legacyAppHost));
      var $fh = require("../../src/feedhenry");

      $fh.reset();

      $fh.init(fhconfig, callback);
      server.respond();

      expect(callback).to.have.been.called;
      expect(callback).to.have.been.calledOnce;
      expect(callback).to.have.been.calledWith("http://localhost:8103");

      var hostUrl = $fh.getCloudURL();
      expect(hostUrl).to.equal("http://localhost:8103");
    });
  });

  describe("test auto initialisation", function(){
    it("should emit cloudready events", function(){

      var callback = sinon.spy();

      initFakeServer(server);
      var $fh = require("../../src/feedhenry");
      
      $fh.reset();

      $fh.on('cloudready', callback);

      server.respond();
      server.respond();

      expect(callback).to.have.been.called;
      expect(callback).to.have.been.calledOnce;
      expect(callback).to.have.been.calledWith({host: "http://localhost:8103"});

      var hostUrl = $fh.getCloudURL();
      expect(hostUrl).to.equal("http://localhost:8103");

    });
  });
});