define(["underscore","jquery","backbone","appFormCore"],function(a,b,c){function d(a,b,c){"undefined"==typeof c&&(c=6371),this._lat="number"==typeof a?a:"string"==typeof a&&""!=a.trim()?+a:0/0,this._lon="number"==typeof b?b:"string"==typeof b&&""!=b.trim()?+b:0/0,this._radius="number"==typeof c?c:"string"==typeof c&&""!=trim(b)?+c:0/0}function f(a,b){this.easting=parseInt(a,10),this.northing=parseInt(b,10)}var g={};g.parseDMS=function(a){if("object"==typeof c)throw new TypeError("Geo.parseDMS - dmsStr is [DOM?] object");if("number"==typeof a&&isFinite(a))return Number(a);var b=String(a).trim().replace(/^-/,"").replace(/[NSEW]$/i,"").split(/[^0-9.,]+/);if(""==b[b.length-1]&&b.splice(b.length-1),""==b)return 0/0;switch(b.length){case 3:var c=b[0]/1+b[1]/60+b[2]/3600;break;case 2:var c=b[0]/1+b[1]/60;break;case 1:var c=b[0];break;default:return 0/0}return/^-|[WS]$/i.test(a.trim())&&(c=-c),Number(c)},g.toDMS=function(a,b,c){if("object"==typeof a)throw new TypeError("Geo.toDMS - deg is [DOM?] object");if(isNaN(a))return null;if("undefined"==typeof b&&(b="dms"),"undefined"==typeof c)switch(b){case"d":c=4;break;case"dm":c=2;break;case"dms":c=0;break;default:b="dms",c=0}switch(a=Math.abs(a),b){case"d":e=a.toFixed(c),100>e&&(e="0"+e),10>e&&(e="0"+e),dms=e+"°";break;case"dm":var d=(60*a).toFixed(c),e=Math.floor(d/60),f=(d%60).toFixed(c);100>e&&(e="0"+e),10>e&&(e="0"+e),10>f&&(f="0"+f),dms=e+"°"+f+"′";break;case"dms":var g=(3600*a).toFixed(c),e=Math.floor(g/3600),f=Math.floor(g/60)%60,h=(g%60).toFixed(c);100>e&&(e="0"+e),10>e&&(e="0"+e),10>f&&(f="0"+f),10>h&&(h="0"+h),dms=e+"°"+f+"′"+h+"″"}return dms},g.toLat=function(a,b,c){var d=g.toDMS(a,b,c);return null==d?"â€“":d.slice(1)+(0>a?"S":"N")},g.toLon=function(a,b,c){var d=g.toDMS(a,b,c);return null==d?"â€“":d+(0>a?"W":"E")},g.toBrng=function(a,b,c){a=(Number(a)+360)%360;var d=g.toDMS(a,b,c);return null==d?"â€“":d.replace("360","0")},window.console||(window.console={log:function(){}}),d.prototype.distanceTo=function(a,b){"undefined"==typeof b&&(b=4);var c=this._radius,d=this._lat.toRad(),e=this._lon.toRad(),f=a._lat.toRad(),g=a._lon.toRad(),h=f-d,i=g-e,j=Math.sin(h/2)*Math.sin(h/2)+Math.cos(d)*Math.cos(f)*Math.sin(i/2)*Math.sin(i/2),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)),l=c*k;return l.toPrecisionFixed(b)},d.prototype.bearingTo=function(a){var b=this._lat.toRad(),c=a._lat.toRad(),d=(a._lon-this._lon).toRad(),e=Math.sin(d)*Math.cos(c),f=Math.cos(b)*Math.sin(c)-Math.sin(b)*Math.cos(c)*Math.cos(d),g=Math.atan2(e,f);return(g.toDeg()+360)%360},d.prototype.finalBearingTo=function(a){var b=a._lat.toRad(),c=this._lat.toRad(),d=(this._lon-a._lon).toRad(),e=Math.sin(d)*Math.cos(c),f=Math.cos(b)*Math.sin(c)-Math.sin(b)*Math.cos(c)*Math.cos(d),g=Math.atan2(e,f);return(g.toDeg()+180)%360},d.prototype.midpointTo=function(a){lat1=this._lat.toRad(),lon1=this._lon.toRad(),lat2=a._lat.toRad();var b=(a._lon-this._lon).toRad(),c=Math.cos(lat2)*Math.cos(b),e=Math.cos(lat2)*Math.sin(b);return lat3=Math.atan2(Math.sin(lat1)+Math.sin(lat2),Math.sqrt((Math.cos(lat1)+c)*(Math.cos(lat1)+c)+e*e)),lon3=lon1+Math.atan2(e,Math.cos(lat1)+c),lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI,new d(lat3.toDeg(),lon3.toDeg())},d.prototype.destinationPoint=function(a,b){b="number"==typeof b?b:"string"==typeof b&&""!=b.trim()?+b:0/0,b/=this._radius,a=a.toRad();var c=this._lat.toRad(),e=this._lon.toRad(),f=Math.asin(Math.sin(c)*Math.cos(b)+Math.cos(c)*Math.sin(b)*Math.cos(a)),g=e+Math.atan2(Math.sin(a)*Math.sin(b)*Math.cos(c),Math.cos(b)-Math.sin(c)*Math.sin(f));return g=(g+3*Math.PI)%(2*Math.PI)-Math.PI,new d(f.toDeg(),g.toDeg())},d.intersection=function(a,b,c,e){return b="number"==typeof b?b:"string"==typeof b&&""!=trim(b)?+b:0/0,e="number"==typeof e?e:"string"==typeof e&&""!=trim(e)?+e:0/0,lat1=a._lat.toRad(),lon1=a._lon.toRad(),lat2=c._lat.toRad(),lon2=c._lon.toRad(),brng13=b.toRad(),brng23=e.toRad(),dLat=lat2-lat1,dLon=lon2-lon1,dist12=2*Math.asin(Math.sqrt(Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)*Math.sin(dLon/2))),0==dist12?null:(brngA=Math.acos((Math.sin(lat2)-Math.sin(lat1)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat1))),isNaN(brngA)&&(brngA=0),brngB=Math.acos((Math.sin(lat1)-Math.sin(lat2)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat2))),Math.sin(lon2-lon1)>0?(brng12=brngA,brng21=2*Math.PI-brngB):(brng12=2*Math.PI-brngA,brng21=brngB),alpha1=(brng13-brng12+Math.PI)%(2*Math.PI)-Math.PI,alpha2=(brng21-brng23+Math.PI)%(2*Math.PI)-Math.PI,0==Math.sin(alpha1)&&0==Math.sin(alpha2)?null:Math.sin(alpha1)*Math.sin(alpha2)<0?null:(alpha3=Math.acos(-Math.cos(alpha1)*Math.cos(alpha2)+Math.sin(alpha1)*Math.sin(alpha2)*Math.cos(dist12)),dist13=Math.atan2(Math.sin(dist12)*Math.sin(alpha1)*Math.sin(alpha2),Math.cos(alpha2)+Math.cos(alpha1)*Math.cos(alpha3)),lat3=Math.asin(Math.sin(lat1)*Math.cos(dist13)+Math.cos(lat1)*Math.sin(dist13)*Math.cos(brng13)),dLon13=Math.atan2(Math.sin(brng13)*Math.sin(dist13)*Math.cos(lat1),Math.cos(dist13)-Math.sin(lat1)*Math.sin(lat3)),lon3=lon1+dLon13,lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI,new d(lat3.toDeg(),lon3.toDeg())))},d.prototype.rhumbDistanceTo=function(a){var b=this._radius,c=this._lat.toRad(),d=a._lat.toRad(),e=(a._lat-this._lat).toRad(),f=Math.abs(a._lon-this._lon).toRad(),g=Math.log(Math.tan(d/2+Math.PI/4)/Math.tan(c/2+Math.PI/4)),h=isFinite(e/g)?e/g:Math.cos(c);Math.abs(f)>Math.PI&&(f=f>0?-(2*Math.PI-f):2*Math.PI+f);var i=Math.sqrt(e*e+h*h*f*f)*b;return i.toPrecisionFixed(4)},d.prototype.rhumbBearingTo=function(a){var b=this._lat.toRad(),c=a._lat.toRad(),d=(a._lon-this._lon).toRad(),e=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(b/2+Math.PI/4));Math.abs(d)>Math.PI&&(d=d>0?-(2*Math.PI-d):2*Math.PI+d);var f=Math.atan2(d,e);return(f.toDeg()+360)%360},d.prototype.rhumbDestinationPoint=function(a,b){var c=this._radius,e=parseFloat(b)/c,f=this._lat.toRad(),g=this._lon.toRad();a=a.toRad();var h=e*Math.cos(a);Math.abs(h)<1e-10&&(h=0);var i=f+h,j=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(f/2+Math.PI/4)),k=isFinite(h/j)?h/j:Math.cos(f),l=e*Math.sin(a)/k;return Math.abs(i)>Math.PI/2&&(i=i>0?Math.PI-i:-Math.PI-i),lon2=(g+l+3*Math.PI)%(2*Math.PI)-Math.PI,new d(i.toDeg(),lon2.toDeg())},d.prototype.rhumbMidpointTo=function(a){lat1=this._lat.toRad(),lon1=this._lon.toRad(),lat2=a._lat.toRad(),lon2=a._lon.toRad(),Math.abs(lon2-lon1)>Math.PI&&(lon1+=2*Math.PI);var b=(lat1+lat2)/2,c=Math.tan(Math.PI/4+lat1/2),e=Math.tan(Math.PI/4+lat2/2),f=Math.tan(Math.PI/4+b/2),g=((lon2-lon1)*Math.log(f)+lon1*Math.log(e)-lon2*Math.log(c))/Math.log(e/c);return isFinite(g)||(g=(lon1+lon2)/2),g=(g+3*Math.PI)%(2*Math.PI)-Math.PI,new d(b.toDeg(),g.toDeg())},d.prototype.lat=function(a,b){return"undefined"==typeof a?this._lat:g.toLat(this._lat,a,b)},d.prototype.lon=function(a,b){return"undefined"==typeof a?this._lon:g.toLon(this._lon,a,b)},d.prototype.toString=function(a,b){return"undefined"==typeof a&&(a="dms"),g.toLat(this._lat,a,b)+", "+g.toLon(this._lon,a,b)},"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI}),"undefined"==typeof Number.prototype.toPrecisionFixed&&(Number.prototype.toPrecisionFixed=function(a){var b=this.toPrecision(a);return b=b.replace(/(.+)e\+(.+)/,function(a,b,c){for(b=b.replace(/\./,""),l=b.length-1;c-->l;)b+="0";return b}),b=b.replace(/(.+)e-(.+)/,function(a,b,c){for(b=b.replace(/\./,"");c-->1;)b="0"+b;return"0."+b})}),"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),window.console||(window.console={log:function(){}}),f.latLongToOsGrid=function(a){var b=a.lat().toRad(),c=a.lon().toRad(),d=6377563.396,e=6356256.91,g=.9996012717,h=49..toRad(),i=(-2).toRad(),j=-1e5,k=4e5,l=1-e*e/(d*d),m=(d-e)/(d+e),n=m*m,o=m*m*m,p=Math.cos(b),q=Math.sin(b),r=d*g/Math.sqrt(1-l*q*q),s=d*g*(1-l)/Math.pow(1-l*q*q,1.5),t=r/s-1,u=(1+m+5/4*n+5/4*o)*(b-h),v=(3*m+3*m*m+21/8*o)*Math.sin(b-h)*Math.cos(b+h),w=(15/8*n+15/8*o)*Math.sin(2*(b-h))*Math.cos(2*(b+h)),x=35/24*o*Math.sin(3*(b-h))*Math.cos(3*(b+h)),y=e*g*(u-v+w-x),z=p*p*p,A=z*p*p,B=Math.tan(b)*Math.tan(b),C=B*B,D=y+j,E=r/2*q*p,F=r/24*q*z*(5-B+9*t),G=r/720*q*A*(61-58*B+C),H=r*p,I=r/6*z*(r/s-B),J=r/120*A*(5-18*B+C+14*t-58*B*t),K=c-i,L=K*K,M=L*K,N=M*K,O=N*K,P=O*K,Q=D+E*L+F*N+G*P,R=k+H*K+I*M+J*O;return new f(R,Q)},f.osGridToLatLong=function(a){var b=a.easting,c=a.northing,e=6377563.396,f=6356256.91,g=.9996012717,h=49*Math.PI/180,i=-2*Math.PI/180,j=-1e5,k=4e5,l=1-f*f/(e*e),m=(e-f)/(e+f),n=m*m,o=m*m*m,p=h,q=0;do{p=(c-j-q)/(e*g)+p;var r=(1+m+5/4*n+5/4*o)*(p-h),s=(3*m+3*m*m+21/8*o)*Math.sin(p-h)*Math.cos(p+h),t=(15/8*n+15/8*o)*Math.sin(2*(p-h))*Math.cos(2*(p+h)),u=35/24*o*Math.sin(3*(p-h))*Math.cos(3*(p+h));q=f*g*(r-s+t-u)}while(c-j-q>=1e-5);var v=Math.cos(p),w=Math.sin(p),x=e*g/Math.sqrt(1-l*w*w),y=e*g*(1-l)/Math.pow(1-l*w*w,1.5),z=x/y-1,A=Math.tan(p),B=A*A,C=B*B,D=C*B,E=1/v,F=x*x*x,G=F*x*x,H=G*x*x,I=A/(2*y*x),J=A/(24*y*F)*(5+3*B+z-9*B*z),K=A/(720*y*G)*(61+90*B+45*C),L=E/x,M=E/(6*F)*(x/y+2*B),N=E/(120*G)*(5+28*B+24*C),O=E/(5040*H)*(61+662*B+1320*C+720*D),P=b-k,Q=P*P,R=Q*P,S=Q*Q,T=R*Q,U=S*Q,V=T*Q;p=p-I*Q+J*S-K*U;var W=i+L*P-M*R+N*T-O*V;return new d(p.toDeg(),W.toDeg())},f.parse=function(a){a=a.trim();var b=a.toUpperCase().charCodeAt(0)-"A".charCodeAt(0),c=a.toUpperCase().charCodeAt(1)-"A".charCodeAt(0);b>7&&b--,c>7&&c--;var d=(b-2)%5*5+c%5,e=19-5*Math.floor(b/5)-Math.floor(c/5);if(0>d||d>6||0>e||e>12)return new f(0/0,0/0);switch(a=a.slice(2).replace(/ /g,""),d+=a.slice(0,a.length/2),e+=a.slice(a.length/2),a.length){case 0:d+="50000",e+="50000";break;case 2:d+="5000",e+="5000";break;case 4:d+="500",e+="500";break;case 6:d+="50",e+="50";break;case 8:d+="5",e+="5";break;case 10:break;default:return new f(0/0,0/0)}return new f(d,e)},f.prototype.toString=function(a){if(a="undefined"==typeof a?10:a,e=this.easting,n=this.northing,0/0==e||0/0==n)return"??";var b=Math.floor(e/1e5),c=Math.floor(n/1e5);if(0>b||b>6||0>c||c>12)return"";var d=19-c-(19-c)%5+Math.floor((b+10)/5),f=5*(19-c)%25+b%5;d>7&&d++,f>7&&f++;var g=String.fromCharCode(d+"A".charCodeAt(0),f+"A".charCodeAt(0));e=Math.floor(e%1e5/Math.pow(10,5-a/2)),n=Math.floor(n%1e5/Math.pow(10,5-a/2));var h=g+" "+e.padLz(a/2)+" "+n.padLz(a/2);return h},"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),"undefined"==typeof String.prototype.padLz&&(Number.prototype.padLz=function(a){for(var b=this.toString(),c=b.length,d=0;a-c>d;d++)b="0"+b;return b}),window.console||(window.console={log:function(){}}),function(a){function b(b,c){function d(b,c){var d,e,f=a(b.target).offset();return clearTimeout(A),A=!1,"undefined"!=typeof b.changedTouches?(d=Math.floor(b.changedTouches[0].pageX-f.left),e=Math.floor(b.changedTouches[0].pageY-f.top)):(d=Math.floor(b.pageX-f.left),e=Math.floor(b.pageY-f.top)),y.x===d&&y.y===e?!0:(null===y.x&&(y.x=d),null===y.y&&(y.y=e),c&&(e+=c),x.beginPath(),x.moveTo(y.x,y.y),x.lineTo(d,e),x.lineCap=t.penCap,x.stroke(),x.closePath(),z.push({lx:d,ly:e,mx:y.x,my:y.y}),y.x=d,y.y=e,void 0)}function e(){B?v.each(function(){this.ontouchmove=null}):v.unbind("mousemove.signaturepad"),y.x=null,y.y=null,z.length>0&&a(t.output,u).val(JSON.stringify(z))}function f(){return t.lineWidth?(x.beginPath(),x.lineWidth=t.lineWidth,x.strokeStyle=t.lineColour,x.moveTo(t.lineMargin,t.lineTop),x.lineTo(w.width-t.lineMargin,t.lineTop),x.stroke(),x.closePath(),void 0):!1}function g(){e(),x.clearRect(0,0,w.width,w.height),x.fillStyle=t.bgColour,x.fillRect(0,0,w.width,w.height),t.displayOnly||f(),x.lineWidth=t.penWidth,x.strokeStyle=t.penColour,a(t.output,u).val(""),z=[]}function h(a){B?v.each(function(){this.addEventListener("touchmove",d,!1)}):v.bind("mousemove.signaturepad",d),d(a,1)}function i(){C=!1,B?v.each(function(){this.removeEventListener("touchstart",e),this.removeEventListener("touchend",e),this.removeEventListener("touchmove",d)}):(v.unbind("mousedown.signaturepad"),v.unbind("mouseup.signaturepad"),v.unbind("mousemove.signaturepad"),v.unbind("mouseleave.signaturepad")),a(t.clear,u).unbind("click.signaturepad")}function j(a){return C?!1:(C=!0,"undefined"!=typeof a.changedTouches&&(B=!0),B?(v.each(function(){this.addEventListener("touchend",e,!1),this.addEventListener("touchcancel",e,!1)}),v.unbind("mousedown.signaturepad")):(v.bind("mouseup.signaturepad",function(){e()}),v.bind("mouseleave.signaturepad",function(){A||(A=setTimeout(function(){e(),clearTimeout(A),A=!1},500))}),v.each(function(){this.ontouchstart=null})),void 0)}function k(){a(t.typed,u).hide(),g(),v.each(function(){this.ontouchstart=function(a){a.preventDefault(),j(a),h(a,this)}}),v.bind("mousedown.signaturepad",function(a){j(a),h(a,this)}),a(t.clear,u).bind("click.signaturepad",function(a){a.preventDefault(),g()}),a(t.typeIt,u).bind("click.signaturepad",function(a){a.preventDefault(),l()}),a(t.drawIt,u).unbind("click.signaturepad"),a(t.drawIt,u).bind("click.signaturepad",function(a){a.preventDefault()}),a(t.typeIt,u).removeClass(t.currentClass),a(t.drawIt,u).addClass(t.currentClass),a(t.sig,u).addClass(t.currentClass),a(t.typeItDesc,u).hide(),a(t.drawItDesc,u).show(),a(t.clear,u).show()}function l(){g(),i(),a(t.typed,u).show(),a(t.drawIt,u).bind("click.signaturepad",function(a){a.preventDefault(),k()}),a(t.typeIt,u).unbind("click.signaturepad"),a(t.typeIt,u).bind("click.signaturepad",function(a){a.preventDefault()}),a(t.output,u).val(""),a(t.drawIt,u).removeClass(t.currentClass),a(t.typeIt,u).addClass(t.currentClass),a(t.sig,u).removeClass(t.currentClass),a(t.drawItDesc,u).hide(),a(t.clear,u).hide(),a(t.typeItDesc,u).show()}function m(b){for(a(t.typed,u).html(b.replace(/>/g,"&gt;").replace(/</g,"&lt;"));a(t.typed,u).width()>w.width;){var c=a(t.typed,u).css("font-size").replace(/px/,"");a(t.typed,u).css("font-size",c-1+"px")}}function n(b,c){a("p."+c.errorClass,b).remove(),b.removeClass(c.errorClass),a("input, label",b).removeClass(c.errorClass)}function o(b,c,d){b.nameInvalid&&(c.prepend(['<p class="',d.errorClass,'">',d.errorMessage,"</p>"].join("")),a(d.name,c).focus(),a(d.name,c).addClass(d.errorClass),a("label[for="+a(d.name).attr("id")+"]",c).addClass(d.errorClass)),b.drawInvalid&&c.prepend(['<p class="',d.errorClass,'">',d.errorMessageDraw,"</p>"].join(""))}function p(){var b=!0,c={drawInvalid:!1,nameInvalid:!1},d=[u,t],e=[c,u,t];return t.onBeforeValidate&&"function"==typeof t.onBeforeValidate?t.onBeforeValidate.apply(s,d):n.apply(s,d),t.drawOnly&&z.length<1&&(c.drawInvalid=!0,b=!1),""===a(t.name,u).val()&&(c.nameInvalid=!0,b=!1),t.onFormError&&"function"==typeof t.onFormError?t.onFormError.apply(s,e):o.apply(s,e),b}function q(a,b,c){for(var d in a)"object"==typeof a[d]&&(b.beginPath(),b.moveTo(a[d].mx,a[d].my),b.lineTo(a[d].lx,a[d].ly),b.lineCap=t.penCap,b.stroke(),b.closePath(),c&&z.push({lx:a[d].lx,ly:a[d].ly,mx:a[d].mx,my:a[d].my}))}function r(){parseFloat((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent)||[0,"4_2"])[1].replace("_","."))<4.1&&(a.fn.Oldoffset=a.fn.offset,a.fn.offset=function(){var b=a(this).Oldoffset();return b.top-=window.scrollY,b.left-=window.scrollX,b}),a(t.typed,u).bind("selectstart.signaturepad",function(b){return a(b.target).is(":input")}),v.bind("selectstart.signaturepad",function(b){return a(b.target).is(":input")}),!w.getContext&&FlashCanvas&&FlashCanvas.initElement(w),w.getContext&&(x=w.getContext("2d"),a(t.sig,u).show(),t.displayOnly||(t.drawOnly||(a(t.name,u).bind("keyup.signaturepad",function(){m(a(this).val())}),a(t.name,u).bind("blur.signaturepad",function(){m(a(this).val())}),a(t.drawIt,u).bind("click.signaturepad",function(a){a.preventDefault(),k()})),t.drawOnly||"drawIt"===t.defaultAction?k():l(),t.validateFields&&(a(b).is("form")?a(b).bind("submit.signaturepad",function(){return p()}):a(b).parents("form").bind("submit.signaturepad",function(){return p()})),a(t.sigNav,u).show()))}var s=this,t=a.extend({},a.fn.signaturePad.defaults,c),u=a(b),v=a(t.canvas,u),w=v.get(0),x=null,y={x:null,y:null},z=[],A=!1,B=!1,C=!1;a.extend(s,{init:function(){r()},regenerate:function(b){s.clearCanvas(),a(t.typed,u).hide(),"string"==typeof b&&(b=JSON.parse(b)),q(b,x,!0),a(t.output,u).length>0&&a(t.output,u).val(JSON.stringify(z))},clearCanvas:function(){g()},getSignature:function(){return z},getSignatureString:function(){return JSON.stringify(z)},getSignatureImage:function(){var a=document.createElement("canvas"),b=null,c=null;return a.style.position="absolute",a.style.top="-999em",a.width=w.width,a.height=w.height,document.body.appendChild(a),!a.getContext&&FlashCanvas&&FlashCanvas.initElement(a),b=a.getContext("2d"),b.fillStyle=t.bgColour,b.fillRect(0,0,w.width,w.height),b.lineWidth=t.penWidth,b.strokeStyle=t.penColour,q(z,b),c=a.toDataURL.apply(a,arguments),document.body.removeChild(a),a=null,c}})}a.fn.signaturePad=function(a){var c=null;return this.each(function(){c=new b(this,a),c.init()}),c},a.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:!1,drawOnly:!1,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:!0,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document",onBeforeValidate:null,onFormError:null}}(b);var h=(function(a,b,c){function d(b){for(var d=[],e=0,f=b.length;f>e;e+=c)d.push(a.apply(null,b.slice(e,e+c)));return d.join("")}function e(a){return[a&b,a>>8&b,a>>16&b,a>>24&b]}function f(a,b,c){for(var d,e,f,g,h,i,j=4*b,k=c-1,l=[];c--;)for(h=j*(k-c),i=j*c,d=0;b>d;d++)e=4*d,f=h+e,g=i+e,l[f]=a[g+2],l[f+1]=a[g+1],l[f+2]=a[g],l[f+3]=a[g+3];return l}function g(a){var c,g=a.width,h=a.height,i=[].concat(e(g),e(h),1,0,32,0,3,0,0,0,e(g*h*4),19,11,0,0,19,11,0,0,0,0,0,0,0,0,0,0,0,0,b,0,0,b,0,0,b,0,0,0,0,0,0,b,32,110,105,87),j=f(a.getContext("2d").getImageData(0,0,g,h).data,g,h);return i=e(i.length).concat(i),c=14+i.length,"data:image/bmp;base64,"+btoa(d([66,77].concat(e(c+j.length),0,0,0,0,e(c),i,j)))}return g}(String.fromCharCode,255,32767),function(a){return a.views={},a.models={},a.collections={},a.config={},a.config.validationOn=!0,a.config.getValueOrDefault=function(a){switch(a){case"cam_quality":return 50;case"cam_targetWidth":return 300;case"cam_targetHeight":return 200}},a}(h||{})),i=c.View.extend({onLoad:function(){},onLoadEnd:function(){}}),j=i.extend({events:{"click button#formlist_reload":"reload"},templates:{list:'<ul class="form_list"></ul>',header:"<h2>Your Forms</h2><h4>Choose a form from the list below</h4>",error:'<li><button id="formlist_reload" class="button-block <%= enabledClass %> <%= dataClass %>"><%= name %><div class="loading"></div></button></li>'},initialize:function(){a.bindAll(this,"render","appendForm"),this.views=[],this.model.on("updated",this.render)},reload:function(){var a=this;this.onLoad(),this.model.refresh(!0,function(b,c){this.onLoadEnd(),a.model=c,a.render()})},show:function(){$(this.el).show()},hide:function(){$(this.el).hide()},renderErrorHandler:function(b){try{(null==b||b.match("error_ajaxfail"))&&(b="An unexpected error occurred.")}catch(c){b="An unexpected error occurred."}var d=a.template(this.templates.error,{name:b+"<br/>Please Retry Later",enabledClass:"button-negative",dataClass:"fetched"});$("ul",this.el).append(d)},render:function(){this.options.parentEl.append(this.templates.list);var b=this.model.getFormsList();b.length>0?(this.options.parentEl.find("ul").append(this.templates.header),a(b).forEach(function(a){this.appendForm(a)},this)):this.renderErrorHandler(arguments[1])},appendForm:function(a){var b=new k({model:a});this.views.push(b),$("ul",this.options.parentEl).append(b.render().el)},initFormList:function(a,b){var c=this;$fh.forms.getForms({fromRemote:a},function(a,d){a?b(a):(c.model=d,b(null,c))})}}),k=i.extend({events:{"click button.show.fetched":"show","click button.show.fetch_error":"fetch"},templates:{form_button:'<li><button class="show button-block <%= enabledClass %> <%= dataClass %>"><%= name %><div class="loading"></div></button></li>'},render:function(){var b,c=!0;return b=a.template(this.templates.form_button,{name:this.model.name,enabledClass:c?"button-main":"",dataClass:"fetched"}),this.$el.html(b),this.$el.find("button").not(".fh_full_data_loaded"),this},unrender:function(){$(this.el).remove()},show:function(){var a=this.model._id,b=new m({parentEl:$("#backbone #page")});b.loadForm({formId:a},function(){b.render(),c.history.navigate("form",!0)})},fetch:function(){}});FieldView=c.View.extend({className:"field_container",fieldWrapper:"<div />",wrapper:'<div id="wrapper_<%= fieldId %>_<%= index %>" title="<%= helpText %>"><%= title %><%= input %><label class="error errorMsg"></label></div>',title:'<label class="<%= required %>"><%= title %> </label><%= helpText %>',input:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>'/> ",instructions:'<p class="instruct"><%= helpText %></p>',fieldActionBar:"<div class='fieldActionBar'><button class='addInputBtn special_button two_button'>Add Input</button><button class='special_button two_button removeInputBtn'>Remove Input</button></div>",events:{change:"contentChanged","blur input,select,textarea":"validate","click .addInputBtn":"onAddInput","click .removeInputBtn":"onRemoveInput"},onAddInput:function(){this.addElement(),this.checkActionBar()},onRemoveInput:function(){this.removeElement(),this.checkActionBar()},checkActionBar:function(){var a=this.curRepeat,b=this.maxRepeat,c=this.initialRepeat;b>a?this.$fieldActionBar.find(".addInputBtn").show():this.$fieldActionBar.find(".addInputBtn").hide(),a>c?this.$fieldActionBar.find(".removeInputBtn").show():this.$fieldActionBar.find(".removeInputBtn").hide()},removeElement:function(){var a=this.curRepeat,b=a-1;this.getWrapper(b).remove(),this.curRepeat--},renderTitle:function(b){var c=this.model.getName(),d=c,e="",f="";return this.model.isRepeating()&&(d+=" ("+(b+1)+") "),this.initialRepeat>1?b<this.initialRepeat&&(e="required"):this.model.isRequired()&&(e="required"),this.model.isRequired()&&b<this.initialRepeat&&(e="required"),0==b&&(f=this.renderHelpText()),a.template(this.title,{title:d,helpText:f,required:e})},renderInput:function(b){var c=this.model.getFieldId(),d=this.type||"text";return a.template(this.input,{fieldId:c,index:b,inputType:d})},renderEle:function(b,c,d){var e=this.model.getHelpText(),f=this.model.getFieldId();return a.template(this.wrapper,{fieldId:f,index:d,helpText:e,title:b,input:c})},renderHelpText:function(){var b=this.model.getHelpText();return a.template(this.instructions,{helpText:b})},addElement:function(){var a=this.curRepeat,b=this.renderTitle(a),c=this.renderInput(a),d=this.renderEle(b,c,a);this.$fieldWrapper.append(d),this.curRepeat++,this.onElementShow(a)},onElementShow:function(){},render:function(){var a=this;this.initialRepeat=1,this.maxRepeat=1,this.curRepeat=0,this.model.isRepeating()&&(this.initialRepeat=this.model.getMinRepeat(),this.maxRepeat=this.model.getMaxRepeat());for(var b=0;b<this.initialRepeat;b++)this.addElement();this.$el.append(this.$fieldWrapper),this.$el.append(this.$fieldActionBar),this.$el.attr("data-field",this.model.getFieldId()),this.options.parentEl.append(this.$el),this.show(),this.$el.hasClass("hide")&&this.hide(!0);var c=this.options.formView.getSubmission();c&&(this.submission=c,this.submission.getInputValueByFieldId(this.model.get("_id"),function(b,c){console.log(b,c),a.value(c)})),this.checkActionBar(),this.onRender()},onRender:function(){},initialize:function(){a.bindAll(this,"dumpContent","clearError","onAddInput","onRemoveInput"),this.$fieldWrapper=$(this.fieldWrapper),this.$fieldActionBar=$(this.fieldActionBar),this.render()},dumpContent:function(){console.log("Value changed :: "+JSON.stringify(this.value()))},getTopView:function(){var a,b=this.options.parentView;do a=b.options.parentView,a&&(b=a);while(a);return b},validate:function(a){if(h.config.validationOn){var b=this,c=$(a.currentTarget),d=c.data().index,e=this.valueFromElement(d),f=this.model.getFieldId();this.model.validate(e,function(a,c){if(a)console.error(a);else{var e=c.validation[f];if(e.valid)b.clearError(d);else{var g=e.errorMessages.join(", ");b.setErrorText(d,g)}}}),this.trigger("checkrules")}},setErrorText:function(a,b){var c=this.getWrapper(a);c.find("label.errorMsg").text(b),c.find("label.errorMsg").show(),c.find("label.errorMsg").addClass("error"),c.find("input,textarea,select").addClass("error")},contentChanged:function(a){{var b=$(a.currentTarget);b.val()}this.dumpContent()},addRules:function(){},isRequired:function(){return this.model.isRequired()},addValidationRules:function(){"1"===this.model.get("IsRequired")&&this.$el.find("#"+this.model.get("ID")).rules("add",{required:!0})},addSpecialRules:function(){var b=this,c={Show:function(a,b){var c="Field"+b.Setting.FieldName;a?h.views.form.showField(c):h.views.form.hideField(c)},Hide:function(a,b){var c="Field"+b.Setting.FieldName;a?h.views.form.hideField(c):h.views.form.showField(c)}};a(this.model.get("Rules")||[]).each(function(d){var e=a.clone(d);e.pageView=b.options.parentView,e.fn=c[d.Type],b.$el.find("#"+b.model.get("ID")).wufoo_rules("add",e)})},removeRules:function(){this.$el.find("#"+this.model.get("ID")).rules("remove")},hide:function(a){(a||this.$el.is(":visible"))&&this.$el.hide()},renderButton:function(a,b,c){var d=$("<button>");d.addClass("special_button"),d.addClass(c),d.attr("data-index",a),d.text(" "+b);var e=$("<img>");return e.attr("src","./img/"+c+".png"),e.css("height","28px"),e.css("width","28px"),d.prepend(e),this.htmlFromjQuery(d)},addButton:function(a,b,c){var d=this,e=$("<button>");e.addClass("special_button"),e.addClass(b),e.text(" "+c);var f=$("<img>");return f.attr("src","./img/"+b+".png"),f.css("height","28px"),f.css("width","28px"),e.prepend(f),e.click(function(a){return d.action(this),a.preventDefault(),!1}),a.append(e),e},show:function(){this.$el.is(":visible")||this.$el.show()},defaultValue:function(){var a={};return a[this.model.get("_id")]=this.model.get("DefaultVal"),a},htmlFromjQuery:function(a){return $("<div>").append(a.clone()).html()},value:function(b){return b&&!a.isEmpty(b)&&this.valuePopulate(b),this.getValue()},getValue:function(){for(var a=[],b=this.curRepeat,c=0;b>c;c++)a[c]=this.valueFromElement(c);return a},valueFromElement:function(a){var b=this.getWrapper(a);return b.find("input,select,textarea").val()||""},valuePopulate:function(a){for(var b=a.length;b>this.curRepeat;)this.addElement();for(var c=0;c<a.length;c++){var d=a[c];this.valuePopulateToElement(c,d)}},valuePopulateToElement:function(a,b){var c=this.getWrapper(a);c.find("input,select,textarea").val(b)},getWrapper:function(a){var b=this.model.getFieldId();return this.$fieldWrapper.find("#wrapper_"+b+"_"+a)},fillArray:function(a,b){for(var c=0;c<a.length;c++)a[c]||(a[c]=b)},clearError:function(a){var b=this.getWrapper(a);b.find("label.errorMsg").hide(),b.find(".error").removeClass("error")}}),FieldCameraView=FieldView.extend({input:'<img class="imageThumb" width="100%" data-field="<%= fieldId %>" data-index="<%= index %>">',html5Cam:'<div class="html5Cam"><div class="camActionBar"><button class="camCancel camBtn">Cancel</button><button class="camOk camBtn">Ok</button></div><div class="cam"></div></div>',onElementShow:function(a){var b=$(this.renderButton(a,"Capture Signature","fhcam")),c=$(this.renderButton(a,"Choose Photo from Library","fhcam_lib")),d=$(this.renderButton(a,"Remove Photo","remove"));this.getWrapper(a).append(b),this.getWrapper(a).append(c),this.getWrapper(a).append(d);var e=this;b.on("click",function(b){e.addFromCamera(b,a)}),c.on("click",function(b){e.addFromLibrary(b,a)}),d.on("click",function(b){e.removeThumb(b,a)}),d.hide()},setImage:function(a,b){var c=this.getWrapper(a),d=c.find("img.imageThumb");d.attr("src",b),c.find("button").hide(),c.find(".remove").show()},getImageThumb:function(a){var b=this.getWrapper(a),c=b.find("img.imageThumb");return c},getCameraBtn:function(a){var b=this.getWrapper(a);return b.find("button.fhcam")},getLibBtn:function(a){var b=this.getWrapper(a);return b.find("button.fhcam_lib")},getRemoveBtn:function(a){var b=this.getWrapper(a);return b.find("button.remove")},removeThumb:function(a,b){a.preventDefault();var c=this.getImageThumb(b);c.removeAttr("src"),this.getLibBtn(b).show(),this.getCameraBtn(b).show(),this.getRemoveBtn(b).hide()},addFromCamera:function(a,b){a.preventDefault();var c=this,d={width:h.config.getValueOrDefault("cam_targetWidth"),height:h.config.getValueOrDefault("cam_targetHeight")};if(this.model.utils.isPhoneGapCamAvailable())this.model.utils.takePhoto(d,function(a,d){a?console.error(a):c.setImage(b,d)});else if(this.model.utils.isHtml5CamAvailable()){var e=$(c.html5Cam),f=e.find(".camActionBar");e.css({position:"fixed",top:0,bottom:0,left:0,right:0,background:"#000","z-index":9999}),f.css({"text-align":"center",padding:"10px",background:"#999"}),f.find("button").css({width:"80px",height:"30px","margin-right":"8px","font-size":"1.3em"}),c.$el.append(e),f.find(".camCancel").on("click",function(){c.model.utils.cancelHtml5Camera(),e.remove()}),this.model.utils.initHtml5Camera(d,function(a,g){a?(console.error(a),alert(a),e.remove()):($(g).css("width","100%"),e.find(".cam").append(g),f.find(".camOk").on("click",function(){c.model.utils.takePhoto(d,function(a,d){e.remove(),a?console.error(a):c.setImage(b,d)})}))})}else{{c.sampleImage()}c.setImage(b,sampleImage)}},addFromLibrary:function(a,b){var c=this,d={width:h.config.getValueOrDefault("cam_targetWidth"),height:h.config.getValueOrDefault("cam_targetHeight")};if(c.model.utils.isPhoneGapCamAvailable())a.preventDefault(),d.sourceType=Camera.PictureSourceType.PHOTOLIBRARY,c.model.utils.takePhoto(d,function(a,d){c.setImage(b,d)});else{var e=document.createElement("input");e.type="file";var f=$(e);f.hide(),c.$el.append(f),f.on("change",function(){var a=f[0];if(a.files&&a.files.length>0){var a=a.files[0];f.remove(),c.model.utils.fileSystem.fileToBase64(a,function(a,d){a?(console.error(a),alser(a)):c.setImage(b,d)})}}),f.click()}},valueFromElement:function(a){var b=this.getImageThumb(a);return b.attr("src")},valuePopulateToElement:function(a,b){if(b){var c=b.data,d=b.imgHeader+c;this.setImage(a,d)}},sampleImages:["/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAAAAAD/4QMraHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjAtYzA2MCA2MS4xMzQ3NzcsIDIwMTAvMDIvMTItMTc6MzI6MDAgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzUgTWFjaW50b3NoIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjVEMzgyQjRCMTU1MjExRTJBNzNDQzMyMEE5ODI5OEU0IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjVEMzgyQjRDMTU1MjExRTJBNzNDQzMyMEE5ODI5OEU0Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NUQzODJCNDkxNTUyMTFFMkE3M0NDMzIwQTk4Mjk4RTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NUQzODJCNEExNTUyMTFFMkE3M0NDMzIwQTk4Mjk4RTQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAAbGhopHSlBJiZBQi8vL0JHPz4+P0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHAR0pKTQmND8oKD9HPzU/R0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0f/wAARCAAyADIDASIAAhEBAxEB/8QATQABAQAAAAAAAAAAAAAAAAAAAAQBAQEBAAAAAAAAAAAAAAAAAAAEBRABAAAAAAAAAAAAAAAAAAAAABEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8AiASt8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//9k=","iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAALklEQVQYV2NkwAT/oUKMyFIoHKAETBFIDU6FIEUgSaJMBJk0MhQihx2W8IcIAQBhewsKNsLKIgAAAABJRU5ErkJggg==","iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAYUlEQVQYV2NkQAJlM1X/g7hd6bdBFCOyHCNIEigBppElkNkgeYIKYBrwKoQ6A+wEuDtwOQHmLLgbQbqQ3YnubhSfwRTj9DUu3+J0I7oGkPVwXwMZKOEHdCdcPdQJILczAAACnDmkK8T25gAAAABJRU5ErkJggg=="],sampleImage:function(){return window.sampleImageNum=(window.sampleImageNum+=1)%this.sampleImages.length,this.sampleImages[window.sampleImageNum]
}}),window.sampleImageNum=-1,FieldCameraGroupView=FieldCameraView.extend({initialize:function(){FieldCameraView.prototype.initialize.call(this);var b=this;this.on("visible",function(){$fh.logger.debug("group visible");var c=this.subviews;a(c).forEach(function(a){b!==a&&a.trigger("visible")})})},render:function(){var a=this;FieldCameraView.prototype.render.call(this),this.options.order=0,this.subviews=[this],this.bind("imageAdded imageRemoved",this.updateFields,this);for(var b=this.model.get("fieldOptions").definition,c=1;c<b.maxRepeat;c++){var d=new FieldCameraView({parentEl:a.options.parentEl,parentView:a.options.parentView,model:a.model,order:c+1,formView:a.options.formView,initHidden:"1"===a.model.IsRequired?!1:!0});d.bind("imageAdded imageRemoved",a.updateFields,a),a.subviews.push(d)}this._optimiseVisibleFields()},updateFields:function(){this._fillBlanks(),this._optimiseVisibleFields()},_fillBlanks:function(){var b=this._getGroupedFields();a(b.optFilled).forEach(function(a){var c=b.empty[0];c&&c.getOrder()<a.getOrder()&&(b.empty.shift(),c.setImageData(a.getImageData(),!0),a.setImageData(null,!1),b.empty.push(a))})},_optimiseVisibleFields:function(){var b=this._getGroupedFields(),c=b.reqFilled.length>=b.req.length?Math.min(b.opt.length,Math.max(0,b.optFilled.length+1)):0;a(b.opt).forEach(function(a,b){c>b?a.show():a.hide()})},_getGroupedFields:function(){var b={req:[],reqEmpty:[],reqFilled:[],opt:[],optEmpty:[],optFilled:[],empty:[]};return a(this.subviews).forEach(function(a){a.isRequired()?(b.req.push(a),a.hasImageData()?b.reqFilled.push(a):(b.reqEmpty.push(a),b.empty.push(a))):(b.opt.push(a),a.hasImageData()?b.optFilled.push(a):(b.optEmpty.push(a),b.empty.push(a)))}),b},value:function(b){return b&&!a.isEmpty(b)&&a(this.subviews).forEach(function(a){FieldCameraView.prototype.value.call(a,b)}),b={},a(this.subviews).forEach(function(a){$.extend(b,FieldCameraView.prototype.value.call(a))}),b}}),FieldCheckboxView=FieldView.extend({choice:'<input data-fieldId="<%= fieldId %>" <%= checked %> data-index="<%= index %>" name="<%= fieldId %>[]" type="checkbox" class="field checkbox" value="<%= value %>" ><label class="choice" ><%= choice %></label><br/>',renderInput:function(b){var c=this.model.getCheckBoxOptions(),d=this.model.getFieldId(),e=this,f="";return $.each(c,function(c,g){f+=a.template(e.choice,{fieldId:d,index:b,choice:g.label,value:g.label,checked:g.selected?"checked='checked'":""})}),f},valueFromElement:function(a){var b=[],c=this.getWrapper(a),d=c.find("input:checked");return d.each(function(){b.push($(this).val())}),b},valuePopulateToElement:function(a,b){var c=this.getWrapper(a);if(b&&!(!b instanceof Array))for(var d=0;d<b.length;d++){var e=b[d];c.find("input[value='"+e+"']").attr("checked","checked")}}}),FieldEmailView=FieldView.extend({type:"email"}),FieldFileView=FieldView.extend({input:"<button style='display:none' data-field='<%= fieldId %>' class='special_button' data-index='<%= index %>'></button><input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>'/> ",type:"file",initialize:function(){this.fileObjs=[],FieldView.prototype.initialize.apply(this,arguments)},contentChanged:function(a){var b=this,c=a.target,d=$(c),e=d.data().index,f=c.files?c.files[0]:null;if(f){var g={fileName:f.name,fileSize:f.size,fileType:f.type};b.showButton(e,g)}else b.showFile(e)},valueFromElement:function(a){var b=this.getWrapper(a),c=b.find("input[type='file']")[0];return c.files&&c.files.length>0?c.files[0]:this.fileObjs[a]},showButton:function(a,b){var c=this.getWrapper(a),d=c.find("button"),e=c.find("input[type='file']");e.hide(),d.show(),d.text(b.fileName+"("+b.fileSize+")"),d.off("click"),d.on("click",function(){$(this).data().index;e.click()})},showFile:function(a){var b=this.getWrapper(a),c=b.find("button"),d=b.find("input[type='file']");c.off("click"),c.hide(),d.show(),this.fileObjs[a]&&(this.fileObjs[a]=null)},valuePopulateToElement:function(a,b){b&&(this.fileObjs[a]=b,this.showButton(a,b))}}),FieldGeoView=FieldView.extend({input:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>' disabled/> ",type:"text",initialize:function(){this.geoValues=[],this.locationUnit=this.model.getFieldDefinition().locationUnit,FieldView.prototype.initialize.apply(this,arguments)},renderInput:function(b){var c="latLong"===this.locationUnit?"Capture Location (Lat/Lon)":"Capture Location (East/North)",d=a.template(this.input,{fieldId:this.model.getFieldId(),index:b,inputType:"text"});return d+=this.renderButton(b,c,"fhgeo")},onRender:function(){var a=this;this.$el.find("button").on("click",function(b){b.preventDefault();var c=$(this),d=c.data().index,e=a.getWrapper(d),f=e.find("input[type='text']");return $fh.geo(function(b){if("latLong"===a.locationUnit)a.geoValues[d]={lat:b.lat,"long":b.lon};else if("northEast"===a.locationUnit){var c=a.convertLocation(b),e=c.toString().split(" ");a.geoValues[d]={zone:e[0],eastings:e[1],northings:e[2]}}a.renderElement(d)},function(){f.attr("placeholder","Location could not be determined")}),!1})},convertLocation:function(a){var b=a.lat,c=a.lon,d={lat:function(){return b},lon:function(){return c}};return f.latLongToOsGrid(d)},renderElement:function(a){var b=this.geoValues[a],c="",d=this.getWrapper(a).find("input[type='text']");b&&("latLong"===this.locationUnit?c="("+b.lat+", "+b.long+")":"northEast"===this.locationUnit&&(c="("+b.zone+" "+b.eastings+", "+b.northings+")"),d.val(c)),d.blur()},valuePopulateToElement:function(a,b){this.geoValues[a]=b,this.renderElement(a)},valueFromElement:function(a){return this.geoValues[a]}}),FieldMapView=FieldView.extend({extension_type:"fhmap",input:"<div data-index='<%= index %>' class='fh_map_canvas' style='width:<%= width%>; height:<%= height%>;'></div>",initialize:function(){this.mapInited=0,this.maps=[],this.mapData=[],this.markers=[],this.allMapInitFunc=[],this.mapSettings={mapWidth:"100%",mapHeight:"300px",defaultZoom:16,location:{lon:-5.80078125,lat:53.12040528310657}},FieldView.prototype.initialize.apply(this,arguments)},renderInput:function(b){return a.template(this.input,{width:this.mapSettings.mapWidth,height:this.mapSettings.mapHeight,index:b})},onMapInit:function(){this.mapInited++,this.mapInited==this.curRepeat&&this.allMapInit()},allMapInit:function(){for(;func=this.allMapInitFunc.shift();)func()},onAllMapInit:function(a){this.mapInited==this.curRepeat?a():-1==this.allMapInitFunc.indexOf(a)&&this.allMapInitFunc.push(a)},onElementShow:function(a){var b=this.getWrapper(a),c=this,d=b.find(".fh_map_canvas")[0];$fh.geo({interval:0},function(b){var e={lat:b.lat,lon:b.lon};$fh.map({target:d,lon:e.lon,lat:e.lat,zoom:c.mapSettings.defaultZoom},function(b){c.maps[a]=b.map;var d=new google.maps.Marker({position:c.maps[a].getCenter(),map:c.maps[a],draggable:!0,animation:google.maps.Animation.DROP,title:"Drag this to set position"});c.markers[a]=d,c.mapData[a]={lat:d.getPosition().lat(),"long":d.getPosition().lng(),zoom:c.mapSettings.defaultZoom},c.onMapInit(a)},function(b){console.error(b),c.onMapInit(a)})})},mapResize:function(){if(this.maps.length>0)for(var a=0;a<this.maps.length;a++){var b=this.maps[a];b&&(google.maps.event.trigger(b,"resize"),b.setCenter(new google.maps.LatLng(this.latLongs[a].lat,this.latLongs[a].long)))}},addValidationRules:function(){},valueFromElement:function(a){var b=this.maps[a],c=this.markers[a];return b&&c?{lat:c.getPosition().lat(),"long":c.getPosition().lng(),zoom:b.getZoom()}:null},valuePopulateToElement:function(a,b){function c(){var c=d.maps[a],e=new google.maps.LatLng(b.lat,b.long);c.setCenter(e),c.setZoom(b.zoom),d.markers[a].setPosition(e)}if(b){var d=this;this.onAllMapInit(c)}}}),FieldNumberView=FieldView.extend({type:"number",valueFromElement:function(a){var b=this.getWrapper(a);return parseFloat(b.find("input,select,textarea").val())||0}}),FieldPhoneView=FieldView.extend({type:"tel"}),FieldRadioView=FieldView.extend({hidden_field:'<input id="radio<%= id %>" type="hidden" value="" data-type="radio">',choice:'<input data-field="<%= fieldId %>" data-index="<%= index %>" name="<%= fieldId %>_<%= index %>" type="radio" class="field radio" value="<%= value %>" ><label class="choice" ><%= choice %></label><br/>',renderInput:function(b){var c=this.model.getRadioOption(),d=this,e="",f=this.model.getFieldId();return $.each(c,function(c,g){var h=$(a.template(d.choice,{fieldId:f,choice:g.label,value:g.label,index:b}));1==g.checked&&h.attr("checked","checked"),e+=d.htmlFromjQuery(h)}),e},valuePopulateToElement:function(a,b){var c=this.getWrapper(a),d=c.find("input[value='"+b+"']");0==d.length&&(d=c.find("input:first-child")),d.attr("checked","checked")},valueFromElement:function(a){var b=this.getWrapper(a);return b.find("input:checked").val()||this.model.getRadioOption()[0].label}}),FieldSelectView=FieldView.extend({select:"<select data-field='<%= fieldId %>' data-index='<%= index %>'><%= options %></select>",option:'<option value="<%= value %>" <%= selected %>><%= value %></option>',renderInput:function(b){var c=this.model.getFieldId(),d=this.model.get("fieldOptions");d=d.definition.options;var e="",f=this;return $.each(d,function(b,c){e+=a.template(f.option,{value:c.label,selected:c.checked?"selected='selected'":""})}),a.template(this.select,{fieldId:c,index:b,options:e})}}),FieldSignatureView=FieldView.extend({extension_type:"fhsig",input:"<img class='sigImage' data-field='<%= fieldId %>' data-index='<%= index %>'/>",signaturePadStyle:"@font-face{font-family:Journal;src:url(journal.eot);src:url(journal.eot?#iefix) format('embedded-opentype'),url(journal.woff) format('woff'),url(journal.ttf) format('truetype'),url(journal.svg#JournalRegular) format('svg');font-weight:400;font-style:normal}.sigPad{margin:0;padding:0;width:250px;height:200px}.sigPad label{display:block;margin:0 0 .515em;padding:0;color:#000;font:italic normal 1em/1.375 Georgia,Times,serif}.sigPad label.error{color:#f33}.sigPad input{margin:0;padding:.2em 0;width:198px;border:1px solid #666;font-size:1em}.sigPad input.error{border-color:#f33}.sigPad button{margin:1em 0 0;padding:.6em .6em .7em;background-color:#ccc;border:0;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px;cursor:pointer;color:#555;font:700 1em/1.375 sans-serif;text-align:left}.sigPad button:hover{background-color:#333;color:#fff}.sig{display:none}.sigNav{display:none;height:2.25em;margin:0;padding:0;position:relative;list-style-type:none}.sigNav li{display:inline;float:left;margin:0;padding:0}.sigNav a,.sigNav a:link,.sigNav a:visited{display:block;margin:0;padding:0 .6em;border:0;color:#333;font-weight:700;line-height:2.25em;text-decoration:underline}.sigNav a.current,.sigNav a.current:link,.sigNav a.current:visited{background-color:#666;-moz-border-radius-topleft:8px;-moz-border-radius-topright:8px;-webkit-border-top-left-radius:8px;-webkit-border-top-right-radius:8px;border-radius:8px 8px 0 0;color:#fff;text-decoration:none}.sigNav .typeIt a.current,.sigNav .typeIt a.current:link,.sigNav .typeIt a.current:visited{background-color:#ccc;color:#555}.sigWrapper{clear:both;height:100px;border:1px solid #ccc}.sigWrapper.current{border-color:#666}.signed .sigWrapper{border:0}.pad{position:relative}.typed{height:55px;margin:0;padding:0 5px;position:absolute;z-index:90;cursor:default;color:#145394;font:400 1.875em/50px Journal,Georgia,Times,serif}.drawItDesc,.typeItDesc{display:none;margin:.75em 0 .515em;padding:.515em 0 0;border-top:3px solid #ccc;color:#000;font:italic normal 1em/1.375 Georgia,Times,serif}",templates:{signaturePad:['<div class="sigPad">','<ul class="sigNav">','<button class="clearButton">Clear</button><button class="cap_sig_done_btn">Done</button>',"</ul>",'<div class="sig sigWrapper">','<canvas class="pad" width="<%= canvasWidth %>" height="<%= canvasHeight %>"></canvas>',"</div>","</div>"]},initialize:function(){FieldView.prototype.initialize.call(this),this.on("visible",this.clearError)},onElementShow:function(a){var b=$(this.renderButton(a,"Capture Signature",this.extension_type));this.getWrapper(a).append(b);var c=this;b.on("click",function(){c.showSignatureCapture(a)})},validate:function(){h.config.validationOn&&this.trigger("checkrules")},onRender:function(){var a=$("<style />");a.text(this.signaturePadStyle),this.$el.append(a)},showSignatureCapture:function(b){var c=this,d=$(window).height(),e=$(window).width(),f=d-70,g=e-2,h=f-20;this.$el.append(a.template(this.templates.signaturePad.join(""),{canvasHeight:f,canvasWidth:g}));var i=$(".sigPad",this.$el);i.css({position:"fixed","z-index":9999,bottom:"0px",right:"0px",top:"0px",left:"0px","background-color":"#fff"});var j=$(".sigNav",this.$el).outerHeight();$(".sigPad",this.$el).css({width:"100%",height:d+"px"}),$(".sigWrapper",this.$el).css({height:d-j-20+"px"}),sigPad=$(".sigPad",this.$el).signaturePad({drawOnly:!0,lineTop:h}),$(this.$el).data("sigpadInited",!0),$(".cap_sig_done_btn",this.$el).unbind("click").bind("click",function(a){a.preventDefault();var d=sigPad.getSignature();if(d&&d.length){var e=sigPad.getSignatureImage();c.isEmptyImage(e)&&(e=c.toBmp()),c.setSignature(b,e)}$(".sigPad",c.$el).hide()})},setSignature:function(a,b){var c=this.getWrapper(a);c.find("img.sigImage").attr("src",b)},valueFromElement:function(a){var b=this.getWrapper(a),c=b.find("img.sigImage");return c.attr("src")},valuePopulateToElement:function(a,b){if(b){var c=b.data,d=b.imgHeader+c,e=this.getWrapper(a),f=e.find("img.sigImage");f.attr("src",d)}},dbgImage:function(a,b){console.log(a+(b?b.substring(0,b.indexOf(","))+"[len="+b.length+"]":" empty"))},toBmp:function(b){b=a.extend({},b||{},{quality:100,width:248,height:100});var c,d=$(".sigPad",self.$el).find("canvas")[0],e=this.scaleCanvas(d,b.width,b.height),f=this.readCanvasData(e),g=this.createBMP(f);return c=this.makeDataURI(g,"image/bmp")},readCanvasData:function(a){var b=parseInt(a.width,10),c=parseInt(a.height,10);return a.getContext("2d").getImageData(0,0,b,c)},encodeData:function(a){var b="";if("string"==typeof a)b=a;else for(var c=a,d=0;d<c.length;d++)b+=String.fromCharCode(c[d]);return btoa(b)},createBMP:function(a){var b=[],c=a.width,d=a.height;b.push(66),b.push(77);var e=c*d*3+54;b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),b.push(0),b.push(0),b.push(0),b.push(0),b.push(54),b.push(0),b.push(0),b.push(0);var f=[];f.push(40),f.push(0),f.push(0),f.push(0);var g=c;f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256);var h=d;f.push(h%256),h=Math.floor(h/256),f.push(h%256),h=Math.floor(h/256),f.push(h%256),h=Math.floor(h/256),f.push(h%256),f.push(1),f.push(0),f.push(24),f.push(0),f.push(0),f.push(0),f.push(0),f.push(0);var i=c*d*3;f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256);for(var j=0;16>j;j++)f.push(0);var k=(4-3*c%4)%4,l=a.data,m="",n=d;do{for(var o=c*(n-1)*4,p="",q=0;c>q;q++){var r=4*q;p+=String.fromCharCode(l[o+r+2]),p+=String.fromCharCode(l[o+r+1]),p+=String.fromCharCode(l[o+r])}for(var s=0;k>s;s++)p+=String.fromCharCode(0);m+=p}while(--n);var t=this.encodeData(b.concat(f))+this.encodeData(m);return t},makeDataURI:function(a,b){return"data:"+b+";base64,"+a},scaleCanvas:function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";var e=d.getContext("2d");return e.drawImage(a,0,0,a.width,a.height,0,0,b,c),d}return a},isEmptyImage:function(a){return null===a||""===a||"data:,"===a},splitImage:function(a){var b="data:",c=";base64,",d=a.indexOf(b),e="image/bmp",f="bmp";if(d>=0){var g=a.indexOf(c,d)+1;e=a.substring(d,g-1),f=e.split("/")[1]}return[e,f]}}),FieldTextView=FieldView.extend({template:['<label class="desc" for="<%= id %>"><%= title %></label>','<input class="field text medium" maxlength="255" id="<%= id %>" name="<%= id %>" type="text" value="<%= defaultVal %>">']}),FieldTextareaView=FieldView.extend({input:"<textarea data-field='<%= fieldId %>' data-index='<%= index %>'  ></textarea>"}),FieldSectionBreak=FieldView.extend({renderEle:function(){return"<hr/>"}}),FieldDateTimeView=FieldView.extend({extension_type:"fhdate",inputTime:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='time'>",inputDate:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='date'>",inputDateTime:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='text'>",renderInput:function(b){var c=this.model.getFieldId(),d=this.getUnit(),e="",f="";"dateTime"==d?(e=this.inputDateTime,f="Get Current Date & Time"):"date"==d?(e=this.inputDate,f="Get Current Date"):"time"==d&&(e=this.inputTime,f="Get Current Time");var g=a.template(e,{fieldId:c,index:b});return g+=this.renderButton(b,f,"fhdate")},getUnit:function(){var a=this.model.getFieldDefinition();return a.dateTimeUnit},onRender:function(){var a=this;this.$el.on("click","button",function(){a.action(this)})},action:function(a){var b=$(a).data().index,c=this,d=new Date;"dateTime"===c.getUnit()?$('input[data-index="'+b+'"]',this.$el).val(c.getDate(d)+" "+c.getTime(d)).blur():"date"===c.getUnit()?$('input[data-index="'+b+'"]',this.$el).val(c.getDate(d)).blur():"time"===c.getUnit()&&$('input[data-index="'+b+'"]',this.$el).val(c.getTime(d)).blur()},getDate:function(a){return"YYYY-MM-DD".replace("YYYY",a.getFullYear()).replace("MM",this.twoDigi(a.getMonth()+1)).replace("DD",this.twoDigi(a.getDate()))},getTime:function(a){return"HH:mm:ss".replace("HH",this.twoDigi(a.getHours())).replace("mm",this.twoDigi(a.getMinutes())).replace("ss",this.twoDigi(a.getSeconds()))},twoDigi:function(a){return 10>a?"0"+a.toString():a.toString()}}),PageView=i.extend({viewMap:{text:FieldTextView,number:FieldNumberView,textarea:FieldTextareaView,radio:FieldRadioView,checkboxes:FieldCheckboxView,dropdown:FieldSelectView,file:FieldFileView,emailAddress:FieldEmailView,phone:FieldPhoneView,location:FieldGeoView,photo:FieldCameraView,signature:FieldSignatureView,locationMap:FieldMapView,dateTime:FieldDateTimeView,sectionBreak:FieldSectionBreak},initialize:function(){var b=this;a.bindAll(this,"render","show","hide"),this.model.on("visible",b.show),this.model.on("hidden",b.hide),this.render()},render:function(){var a=this;this.fieldViews={},this.$el.empty().addClass("page hidden"),this.options.parentEl.append(this.$el);var b=this.model.getFieldModelList();b.forEach(function(b){var c=b.getType();a.viewMap[c]?(console.log("*- "+c),a.fieldViews[b.get("_id")]=new a.viewMap[c]({parentEl:a.$el,parentView:a,model:b,formView:a.options.formView})):console.warn("FIELD NOT SUPPORTED:"+c)})},show:function(){this.$el.removeClass("hidden")},hide:function(){this.$el.addClass("hidden")},showField:function(a){this.fieldViews[a]&&this.fieldViews[a].show()},hideField:function(a){this.fieldViews[a]&&this.fieldViews[a].hide()},isValid:function(){var a=this.$el.find("input,select,option,textarea").not('.validate_ignore,[type!="hidden"]:hidden');return a.length?a.valid():!0},checkRules:function(){var b=this,c={},d={SkipToPage:function(a,b){var d=b.Setting.Page;a&&(c.skipToPage=d)}};return a(this.model.get("Rules")||[]).forEach(function(a,c){var e=b.$el.find("#Field"+a.condition.FieldName+",#radioField"+a.condition.FieldName);if(a.fn=d[a.Type],"radio"===e.data("type")){var f=b.$el.find("#Field"+a.condition.FieldName+"_"+c);f.wufoo_rules("exec",a)}else e.wufoo_rules("exec",a)}),c}});{var m=i.extend({pageNum:0,pageCount:0,pageViews:[],submission:null,fieldValue:[],templates:{buttons:'<div id="buttons" class="fh_action_bar"><button class="saveDraft hidden button button-main">Save Draft</button><button class="previous hidden button">Previous</button><button class="next hidden button">Next</button><button class="submit hidden button button-positive">Submit</button></div>'},events:{"click button.next":"nextPage","click button.previous":"prevPage","click button.saveDraft":"saveToDraft","click button.submit":"submit"},initialize:function(){a.bindAll(this,"checkRules","onValidateError"),this.el=this.options.parentEl,this.fieldModels=[],this.el.empty()},loadForm:function(a,b){var c=this;a.formId?(this.onLoad(),$fh.forms.getForm(a,function(d,e){if(d)throw d.body;c.form=e,c.params=a,c.initWithForm(e,a),b()})):a.form&&(c.form=a.form,c.params=a,c.initWithForm(a.form,a),b())},readOnly:function(){this.readonly=!0;for(var a,b=0;a=this.fieldViews[b];b++)a.$el.find("button,input,textarea,select").attr("disabled","disabled");this.el.find("button.saveDraft").hide(),this.el.find(" button.submit").hide()},onValidateError:function(a){var b=null;for(var c in a)if(a[c]){var d=this.getFieldViewById(c);null==b&&(b=d);for(var e=a[c].fieldErrorMessage,f=0;f<e.length;f++)e[f]&&d.setErrorText(f,e[f])}},initWithForm:function(a,b){var c=this;c.formId=a.getFormId(),c.el.empty(),c.model=a,b.submission||(b.submission=c.model.newSubmission()),c.submission=b.submission,c.submission.on("validationerror",c.onValidateError);for(var d,e=a.getPageModelList(),f=[],g=0;d=e[g];g++){var h=d.getFieldModelList();c.fieldModels=c.fieldModels.concat(h);var i=new PageView({model:d,parentEl:c.el,formView:c});f.push(i)}for(var i,j=[],g=0;i=f[g];g++){var k=i.fieldViews;for(var l in k){var m=k[l];j.push(m),m.on("checkrules",c.checkRules),c.readonly&&m.$el.find("input,button,textarea,select").attr("disabled","disabled")}}c.fieldViews=j,c.pageViews=f,c.pageCount=f.length,c.onLoadEnd()},checkRules:function(){var a=this;this.populateFieldViewsToSubmission(!1,function(){var b=a.submission;b.checkRules(function(b,c){if(b)console.error(b);else{var d=c.actions,e=d.pages,f=d.fields;for(var g in e)a.performRuleAction("page",g,e[g].action);for(var g in f)a.performRuleAction("field",g,f[g].action)}})})},performRuleAction:function(a,b,c){var d=null;if("page"==a?d=this.getPageViewById(b):"field"==a&&(d=this.getFieldViewById(b)),null==d)return console.error("cannot find target with id:"+b),void 0;switch(c){case"show":d.show();break;case"hide":d.hide();break;default:console.error("action not defined:"+c)}},rebindButtons:function(){var a=this;this.el.find("button.next").unbind().bind("click",function(){a.nextPage()}),this.el.find("button.previous").unbind().bind("click",function(){a.prevPage()}),this.el.find("button.saveDraft").unbind().bind("click",function(){a.saveToDraft()}),this.el.find("button.submit").unbind().bind("click",function(){a.submit()})},setSubmission:function(a){this.submission=a},getSubmission:function(){return this.submission},getPageViewById:function(a){for(var b,c=0;b=this.pageViews[c];c++){var d=b.model.getPageId();if(d==a)return b}return null},getFieldViewById:function(a){for(var b,c=0;b=this.fieldViews[c];c++){var d=b.model.getFieldId();if(d==a)return b}return null},checkPages:function(){0===this.pageNum&&this.pageNum===this.pageCount-1?(this.el.find(" button.previous").hide(),this.el.find("button.next").hide(),this.el.find("button.saveDraft").show(),this.el.find(" button.submit").show(),this.el.find("button").addClass("two_button")):0===this.pageNum?(this.el.find(" button.previous").hide(),this.el.find("button.next").show(),this.el.find("button.saveDraft").show(),this.el.find(" button.submit").hide(),this.el.find("button").addClass("two_button")):this.pageNum===this.pageCount-1?(this.el.find(" button.previous").show(),this.el.find(" button.next").hide(),this.el.find(" button.saveDraft").show(),this.el.find(" button.submit").show(),this.el.find("button").addClass("three_button")):(this.el.find(" button.previous").show(),this.el.find(" button.next").show(),this.el.find(" button.saveDraft").show(),this.el.find(" button.submit").hide(),this.el.find("button").addClass("three_button")),this.readonly&&(this.el.find("button.saveDraft").hide(),this.el.find(" button.submit").hide())},render:function(){this.el.append(this.templates.buttons),this.rebindButtons(),this.pageViews[0].show(),this.checkPages(),this.checkRules()},nextPage:function(){this.hideAllPages(),this.pageViews[this.pageNum+1].show(),this.pageNum=this.pageNum+1,this.checkPages()},prevPage:function(){this.hideAllPages(),this.pageViews[this.pageNum-1].show(),this.pageNum=this.pageNum-1,this.checkPages()},hideAllPages:function(){this.pageViews.forEach(function(a){a.hide()})},submit:function(){var a=this;this.populateFieldViewsToSubmission(function(){a.submission.submit(function(b){b?console.error(b):a.el.empty()})})},saveToDraft:function(){var a=this;this.populateFieldViewsToSubmission(function(){a.submission.saveDraft(function(){a.el.empty()})})},populateFieldViewsToSubmission:function(a,b){"undefined"==typeof b&&(b=a,a=!0);for(var c,d=this.submission,e=this.fieldViews,f=[],g=0;c=e[g];g++){var h=c.value(),i=c.model.getFieldId(),j=c.model.getType();if("sectionBreak"!==j)for(var k=0;k<h.length;k++){var l=h[k];f.push({id:i,value:l,index:k})}}var m=f.length;d.reset();for(var n,g=0;n=f[g];g++){var i=n.id,o=n.value,p=n.index;d.addInputValue({fieldId:i,value:o,index:p,isStore:a},function(a){a&&console.error(a),m--,0==m&&b()})}},setInputValue:function(a,b){for(var c,d=0;c=this.fieldValue[d];d++)c.id==a&&this.fieldValue.splice(d,1);for(var e,d=0;e=b[d];d++)this.fieldValue.push({id:a,value:e});console.log("INPUT VALUE SET",a,b)}});i.extend({events:{"click button#convert":"convert"},templates:{body:'<h1>Insert JSON</h1><textarea id="jsonBox" rows="30" cols="50"></textarea><button id="convert">Convert</button><div id="resultArea"></div>'},el:"#jsonPage",initialize:function(){a.bindAll(this,"render")},show:function(){$(this.el).show()},hide:function(){$(this.el).hide()},render:function(){$(this.el).html(this.templates.body),this.show()},convert:function(){var a=$("#jsonBox").val();try{var b=JSON.parse(a)}catch(c){throw console.log(c),"Invalid JSON object"}var d={formId:(new Date).getTime(),rawMode:!0,rawData:b},e=new m({parentEl:$("#backbone #resultArea")});e.loadForm(d,function(){e.render()})}})}return"undefined"==typeof $fh&&($fh={}),$fh.forms||($fh.forms={}),$fh.forms.renderForm=function(a,b){var c=a.container,d=(a.formId,a.fromRemote||!1,a.type||"backbone"),e=new m({parentEl:c});e.loadForm(a,function(){"backbone"==d?b(null,e):"html"==d&&b(null,e)})},$fh.forms.renderFormList=function(a){var b=a.fromRemote||!1,c=a.parentEl;$fh.forms.getForms({fromRemote:b},function(a,b){formListView=new j({model:b,parentEl:c}),formListView.render()})},$fh.forms.backbone={},$fh.forms.backbone.FormView=m,$fh.forms});